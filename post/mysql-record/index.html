<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>MySQL复习整理 - Wallis</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="bomir" />
  <meta name="description" content="1.MySQL环境 1.1.环境安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # 查看Lin" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.85.0" />


<link rel="canonical" href="https://bomir.top/post/mysql-record/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="MySQL复习整理" />
<meta property="og:description" content="1.MySQL环境 1.1.环境安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # 查看Lin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bomir.top/post/mysql-record/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-11-12T22:19:05+00:00" />
<meta property="article:modified_time" content="2020-11-12T22:19:05+00:00" />

<meta itemprop="name" content="MySQL复习整理">
<meta itemprop="description" content="1.MySQL环境 1.1.环境安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # 查看Lin"><meta itemprop="datePublished" content="2020-11-12T22:19:05+00:00" />
<meta itemprop="dateModified" content="2020-11-12T22:19:05+00:00" />
<meta itemprop="wordCount" content="28679">
<meta itemprop="keywords" content="mysql," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL复习整理"/>
<meta name="twitter:description" content="1.MySQL环境 1.1.环境安装 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # 查看Lin"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">秤流沙</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      秤流沙
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">MySQL复习整理</h1>
      
      <div class="post-meta">
        <time datetime="2020-11-12" class="post-time">
          2020-11-12
        </time>
        <div class="post-category">
            <a href="https://bomir.top/categories/mysql/"> mysql </a>
            
          </div>
        <span class="more-meta"> 约 28679 字 </span>
          <span class="more-meta"> 预计阅读 58 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#11环境安装">1.1.环境安装</a></li>
    <li><a href="#12安装位置">1.2.安装位置</a></li>
    <li><a href="#13修改字符集">1.3.修改字符集</a></li>
    <li><a href="#14配置文件">1.4.配置文件</a></li>
  </ul>

  <ul>
    <li><a href="#71索引简介">7.1.索引简介</a></li>
    <li><a href="#72mysql索引分类">7.2.MySQL索引分类</a></li>
    <li><a href="#73mysql索引数据结构">7.3MySQL索引数据结构</a></li>
    <li><a href="#74哪些情况需要建索引">7.4.哪些情况需要建索引</a></li>
    <li><a href="#75哪些情况不要建索引">7.5.哪些情况不要建索引</a></li>
  </ul>

  <ul>
    <li><a href="#81explain简介">8.1.EXPLAIN简介</a></li>
    <li><a href="#82explain字段">8.2.EXPLAIN字段</a></li>
  </ul>

  <ul>
    <li><a href="#91单表索引分析">9.1.单表索引分析</a></li>
    <li><a href="#92两表索引分析">9.2.两表索引分析</a></li>
    <li><a href="#93三张表索引分析">9.3.三张表索引分析</a></li>
    <li><a href="#94结论">9.4.结论</a></li>
  </ul>

  <ul>
    <li><a href="#101索引失效的情况">10.1.索引失效的情况</a></li>
    <li><a href="#102最佳左前缀法则">10.2.最佳左前缀法则</a></li>
    <li><a href="#103索引列上不计算">10.3.索引列上不计算</a></li>
    <li><a href="#104范围之后全失效">10.4.范围之后全失效</a></li>
    <li><a href="#105覆盖索引尽量用">10.5.覆盖索引尽量用</a></li>
    <li><a href="#106不等有时会失效">10.6.不等有时会失效</a></li>
    <li><a href="#107like百分加右边">10.7.like百分加右边</a></li>
    <li><a href="#108字符要加单引号">10.8.字符要加单引号</a></li>
    <li><a href="#109索引相关题目">10.9.索引相关题目</a></li>
    <li><a href="#1010面试题分析">10.10.面试题分析</a></li>
    <li><a href="#1011总结">10.11.总结</a></li>
  </ul>

  <ul>
    <li><a href="#121小表驱动大表">12.1.小表驱动大表</a></li>
    <li><a href="#122order-by优化">12.2.ORDER BY优化</a></li>
    <li><a href="#123gorup-by优化">12.3.GORUP BY优化</a></li>
    <li><a href="#124总结">12.4.总结</a></li>
  </ul>

  <ul>
    <li><a href="#131基本介绍">13.1.基本介绍</a></li>
    <li><a href="#132日志分析工具">13.2.日志分析工具</a></li>
  </ul>

  <ul>
    <li><a href="#141环境准备">14.1.环境准备</a></li>
    <li><a href="#142创建函数">14.2.创建函数</a></li>
    <li><a href="#143创建存储过程">14.3.创建存储过程</a></li>
    <li><a href="#144调用存储过程">14.4.调用存储过程</a></li>
  </ul>

  <ul>
    <li><a href="#161环境准备">16.1.环境准备</a></li>
    <li><a href="#162锁表的命令">16.2.锁表的命令</a></li>
    <li><a href="#163读锁案例">16.3.读锁案例</a></li>
    <li><a href="#164写锁案例">16.4.写锁案例</a></li>
    <li><a href="#165案例结论">16.5.案例结论</a></li>
    <li><a href="#166表锁分析">16.6.表锁分析</a></li>
  </ul>

  <ul>
    <li><a href="#171环境准备">17.1.环境准备</a></li>
    <li><a href="#172行锁案例">17.2.行锁案例</a></li>
    <li><a href="#173索引失效行锁变表锁">17.3.索引失效行锁变表锁</a></li>
    <li><a href="#174间隙锁的危害">17.4.间隙锁的危害</a></li>
    <li><a href="#175如何锁定一行">17.5.如何锁定一行</a></li>
    <li><a href="#176案例结论">17.6.案例结论</a></li>
    <li><a href="#177行锁分析">17.7.行锁分析</a></li>
  </ul>

  <ul>
    <li><a href="#181复制基本原理">18.1.复制基本原理</a></li>
    <li><a href="#182复制基本原则">18.2.复制基本原则</a></li>
    <li><a href="#183一主一从配置">18.3.一主一从配置</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="1mysql环境">1.MySQL环境</h1>
<h2 id="11环境安装">1.1.环境安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 查看Linux服务器上是否安装过MySQL</span>
rpm -qa <span class="p">|</span> grep -i mysql <span class="c1"># 查询出所有mysql依赖包</span>

<span class="c1"># 1、拉取镜像</span>
docker pull mysql:5.7

<span class="c1"># 2、创建实例并启动</span>
docker run -p 3306:3306 --name mysql <span class="se">\
</span><span class="se"></span>-v /root/mysql/log:/var/log/mysql <span class="se">\
</span><span class="se"></span>-v /root/mysql/data:/var/lib/mysql <span class="se">\
</span><span class="se"></span>-v /root/mysql/conf:/etc/mysql <span class="se">\
</span><span class="se"></span>-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="m">333</span> <span class="se">\
</span><span class="se"></span>-d mysql:5.7

<span class="c1"># 3、mysql配置 /root/mysql/conf/my.conf</span>
<span class="o">[</span>client<span class="o">]</span>
<span class="c1">#mysqlde utf8字符集默认为3位的，不支持emoji表情及部分不常见的汉字，故推荐使用utf8mb4</span>
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysql<span class="o">]</span>
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysqld<span class="o">]</span>
<span class="c1">#设置client连接mysql时的字符集,防止乱码</span>
<span class="nv">init_connect</span><span class="o">=</span><span class="s1">&#39;SET collation_connection = utf8_general_ci&#39;</span>
<span class="nv">init_connect</span><span class="o">=</span><span class="s1">&#39;SET NAMES utf8&#39;</span>

<span class="c1">#数据库默认字符集</span>
character-set-server<span class="o">=</span>utf8

<span class="c1">#数据库字符集对应一些排序等规则，注意要和character-set-server对应</span>
collation-server<span class="o">=</span>utf8_general_ci

<span class="c1"># 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置</span>
skip-character-set-client-handshake

<span class="c1"># 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！</span>
skip-name-resolve

<span class="c1"># 4、重启mysql容器</span>
docker restart mysql

<span class="c1"># 5、进入到mysql容器</span>
docker <span class="nb">exec</span> -it mysql /bin/bash

<span class="c1"># 6、查看修改的配置文件</span>
cat /etc/mysql/my.conf
</code></pre></td></tr></table>
</div>
</div><h2 id="12安装位置">1.2.安装位置</h2>
<p><code>Docker</code>容器就是一个小型的<code>Linux</code>环境，进入到<code>MySQL</code>容器中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">docker <span class="nb">exec</span> -it mysql /bin/bash
</code></pre></td></tr></table>
</div>
</div><p><code>Linux</code>环境下<code>MySQL</code>的安装目录。</p>
<table>
<thead>
<tr>
<th>路径</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/var/lib/mysql</code></td>
<td>MySQL数据库文件存放位置</td>
</tr>
<tr>
<td><code>/usr/share/mysql</code></td>
<td>错误消息和字符集文件配置</td>
</tr>
<tr>
<td><code>/usr/bin</code></td>
<td>客户端程序和脚本</td>
</tr>
<tr>
<td><code>/etc/init.d/mysql</code></td>
<td>启停脚本相关</td>
</tr>
</tbody>
</table>
<h2 id="13修改字符集">1.3.修改字符集</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、进入到mysql数据库并查看字符集</span>
<span class="c1"># show variables like &#39;character%&#39;;</span>
<span class="c1"># show variables like &#39;%char%&#39;;</span>

mysql&gt; show variables like <span class="s1">&#39;character%&#39;</span><span class="p">;</span>
+--------------------------+----------------------------+
<span class="p">|</span> Variable_name            <span class="p">|</span> Value                      <span class="p">|</span>
+--------------------------+----------------------------+
<span class="p">|</span> character_set_client     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_connection <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_database   <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_filesystem <span class="p">|</span> binary                     <span class="p">|</span>
<span class="p">|</span> character_set_results    <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_server     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_system     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_sets_dir       <span class="p">|</span> /usr/share/mysql/charsets/ <span class="p">|</span>
+--------------------------+----------------------------+
<span class="m">8</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; show variables like <span class="s1">&#39;%char%&#39;</span><span class="p">;</span>
+--------------------------+----------------------------+
<span class="p">|</span> Variable_name            <span class="p">|</span> Value                      <span class="p">|</span>
+--------------------------+----------------------------+
<span class="p">|</span> character_set_client     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_connection <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_database   <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_filesystem <span class="p">|</span> binary                     <span class="p">|</span>
<span class="p">|</span> character_set_results    <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_server     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_set_system     <span class="p">|</span> utf8                       <span class="p">|</span>
<span class="p">|</span> character_sets_dir       <span class="p">|</span> /usr/share/mysql/charsets/ <span class="p">|</span>
+--------------------------+----------------------------+
<span class="m">8</span> rows in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>MySQL5.7</code>配置文件位置是<code>/etc/my.cnf</code>或者<code>/etc/mysql/my.cnf</code>，如果字符集不是<code>utf-8</code>直接进入配置文件修改即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>client<span class="o">]</span>
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysql<span class="o">]</span>
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysqld<span class="o">]</span>
<span class="c1"># 设置client连接mysql时的字符集,防止乱码</span>
<span class="nv">init_connect</span><span class="o">=</span><span class="s1">&#39;SET NAMES utf8&#39;</span>
<span class="nv">init_connect</span><span class="o">=</span><span class="s1">&#39;SET collation_connection = utf8_general_ci&#39;</span>

<span class="c1"># 数据库默认字符集</span>
character-set-server<span class="o">=</span>utf8

<span class="c1">#数据库字符集对应一些排序等规则，注意要和character-set-server对应</span>
collation-server<span class="o">=</span>utf8_general_ci

<span class="c1"># 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置</span>
skip-character-set-client-handshake

<span class="c1"># 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！</span>
skip-name-resolve
</code></pre></td></tr></table>
</div>
</div><p><strong>注意：安装<code>MySQL</code>完毕之后，第一件事就是修改字符集编码。</strong></p>
<h2 id="14配置文件">1.4.配置文件</h2>
<p><strong><code>MySQL</code>配置文件讲解：https://www.cnblogs.com/gaoyuechen/p/10273102.html</strong></p>
<p>1、二进制日志<code>log-bin</code>：主从复制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># my,cnf</span>
<span class="c1"># 开启mysql binlog功能</span>
log-bin<span class="o">=</span>mysql-bin
</code></pre></td></tr></table>
</div>
</div><p>2、错误日志<code>log-error</code>：默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># my,cnf</span>
<span class="c1"># 数据库错误日志文件</span>
log-error <span class="o">=</span> error.log
</code></pre></td></tr></table>
</div>
</div><p>3、查询日志<code>log</code>：默认关闭，记录查询的<code>sql</code>语句，如果开启会降低<code>MySQL</code>整体的性能，因为记录日志需要消耗系统资源。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># my,cnf</span>
<span class="c1"># 慢查询sql日志设置</span>
<span class="nv">slow_query_log</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">slow_query_log_file</span> <span class="o">=</span> slow.log
</code></pre></td></tr></table>
</div>
</div><p>4、数据文件。</p>
<ul>
<li><code>frm文件</code>：存放表结构。</li>
<li><code>myd</code>文件：存放表数据。</li>
<li><code>myi</code>文件：存放表索引。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># mysql5.7 使用.frm文件来存储表结构</span>
<span class="c1"># 使用 .ibd文件来存储表索引和表数据</span>
-rw-r-----  <span class="m">1</span> mysql mysql   <span class="m">8988</span> Jun <span class="m">25</span> 09:31 pms_category.frm
-rw-r-----  <span class="m">1</span> mysql mysql <span class="m">245760</span> Jul <span class="m">21</span> 10:01 pms_category.ibd
</code></pre></td></tr></table>
</div>
</div><p><code>MySQL5.7</code>的<code>Innodb</code>存储引擎可将所有数据存放于<code>ibdata*</code>的共享表空间，也可将每张表存放于独立的<code>.ibd</code>文件的独立表空间。
共享表空间以及独立表空间都是针对数据的存储方式而言的。</p>
<ul>
<li>共享表空间: 某一个数据库的所有的表数据，索引文件全部放在一个文件中，默认这个共享表空间的文件路径在<code>data</code>目录下。 默认的文件名为<code>:ibdata1</code> 初始化为<code>10M</code>。</li>
<li>独立表空间: 每一个表都将会生成以独立的文件方式来进行存储，每一个表都有一个<code>.frm</code>表描述文件，还有一个<code>.ibd</code>文件。 其中这个文件包括了单独一个表的数据内容以及索引内容，默认情况下它的存储位置也是在表的位置之中。在配置文件<code>my.cnf</code>中设置： <code>innodb_file_per_table</code>。</li>
</ul>
<h1 id="2mysql逻辑架构">2.MySQL逻辑架构</h1>
<p><img src="https://img-blog.csdn.net/20180831173911997?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pfcnlhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="MySQL逻辑架构"></p>
<ul>
<li>
<p><code>Connectors</code>：指的是不同语言中与SQL的交互。</p>
</li>
<li>
<p><code>Connection Pool</code>：管理缓冲用户连接，线程处理等需要缓存的需求。<strong>MySQL数据库的连接层。</strong></p>
</li>
<li>
<p><code> Management Serveices &amp; Utilities</code>：系统管理和控制工具。备份、安全、复制、集群等等。。</p>
</li>
<li>
<p><code>SQL Interface</code>：接受用户的SQL命令，并且返回用户需要查询的结果。</p>
</li>
<li>
<p><code>Parser</code>：SQL语句解析器。</p>
</li>
<li>
<p><code>Optimizer</code>：查询优化器，SQL语句在查询之前会使用查询优化器对查询进行优化。<strong>就是优化客户端请求query</strong>，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果。<strong>For Example</strong>： <code>select uid,name from user where gender = 1;</code>这个<code>select </code>查询先根据<code>where </code>语句进行选取，而不是先将表全部查询出来以后再进行<code>gender</code>过滤；然后根据<code>uid</code>和<code>name</code>进行属性投影，而不是将属性全部取出以后再进行过滤。最后将这两个查询条件联接起来生成最终查询结果。</p>
</li>
<li>
<p><code>Caches &amp; Buffers</code>：查询缓存。</p>
</li>
<li>
<p><code>Pluggable Storage Engines</code>：<strong>存储引擎接口。MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎(注意：存储引擎是基于表的，而不是数据库)。</strong></p>
</li>
<li>
<p><code>File System</code>：数据落地到磁盘上，就是文件的存储。</p>
</li>
</ul>
<p>MySQL数据库和其他数据库相比，MySQL有点与众不同，主要体现在存储引擎的架构上，<strong>插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取相分离</strong>。这种架构可以根据业务的需求和实际需求选择合适的存储引擎。</p>
<blockquote>
<p>逻辑架构分层</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20200801165252510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="MySQL逻辑架构"></p>
<ul>
<li>
<p>连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于<code>tcp/ip</code>的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于<code>SSL</code>的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p>
</li>
<li>
<p>服务层：MySQL的核心服务功能层，该层是MySQL的核心，包括查询缓存，解析器，解析树，预处理器，查询优化器。主要进行查询解析、分析、查询缓存、内置函数、存储过程、触发器、视图等，select操作会先检查是否命中查询缓存，命中则直接返回缓存数据，否则解析查询并创建对应的解析树。</p>
</li>
<li>
<p>引擎层：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。</p>
</li>
<li>
<p>存储层：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</p>
</li>
</ul>
<h1 id="3存储引擎">3.存储引擎</h1>
<p><code>show engines;</code>命令查看MySQL5.7支持的存储引擎。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; show engines<span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://img-blog.csdnimg.cn/20200801170442428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="存储引擎"></p>
<p><code>show variables like 'default_storage_engine%';</code>查看当前数据库正在使用的存储引擎。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; show variables like <span class="s1">&#39;default_storage_engine%&#39;</span><span class="p">;</span>
+------------------------+--------+
<span class="p">|</span> Variable_name          <span class="p">|</span> Value  <span class="p">|</span>
+------------------------+--------+
<span class="p">|</span> default_storage_engine <span class="p">|</span> InnoDB <span class="p">|</span>
+------------------------+--------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>InnoDB和MyISAM对比</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">对比项</th>
<th style="text-align:center">MyISAM</th>
<th style="text-align:center">InnoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">主外键</td>
<td style="text-align:center">不支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:left">事务</td>
<td style="text-align:center">不支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:left">行表锁</td>
<td style="text-align:center">表锁，即使操作一条记录也会锁住整张表，<strong>不适合高并发操作</strong></td>
<td style="text-align:center">行锁，操作时只锁某一行，不对其他行有影响，<strong>适合高并发操作</strong></td>
</tr>
<tr>
<td style="text-align:left">缓存</td>
<td style="text-align:center">只缓存索引，不缓存真实数据</td>
<td style="text-align:center">不仅缓存索引还要缓存真实数据，対内存要求较高，而且内存大小対性能有决定性影响</td>
</tr>
<tr>
<td style="text-align:left">表空间</td>
<td style="text-align:center">小</td>
<td style="text-align:center">大</td>
</tr>
<tr>
<td style="text-align:left">关注点</td>
<td style="text-align:center">性能</td>
<td style="text-align:center">事务</td>
</tr>
<tr>
<td style="text-align:left">默认安装</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
</tr>
</tbody>
</table>
<h1 id="4sql性能下降的原因">4.SQL性能下降的原因</h1>
<ul>
<li>查询语句写的差。</li>
<li>索引失效：索引建了，但是没有用上。</li>
<li>关联 查询太多<code>join</code>（设计缺陷或者不得已的需求）。</li>
<li>服务器调优以及各个参数的设置（缓冲、线程数等）。</li>
</ul>
<h1 id="5sql执行顺序">5.SQL执行顺序</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="k">select</span>              <span class="c1"># 5</span>
	... 
from                <span class="c1"># 1</span>
	... 
where               <span class="c1"># 2</span>
	.... 
group by            <span class="c1"># 3</span>
	... 
having              <span class="c1"># 4</span>
	... 
order by            <span class="c1"># 6</span>
	... 
limit               <span class="c1"># 7</span>
	<span class="o">[</span>offset<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="6七种join理论">6.七种JOIN理论</h1>
<p><img src="https://img-blog.csdnimg.cn/20200801212011559.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="七种JOIN理论"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 1 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 4 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 5 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 6 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="cm">/* MySQL不支持FULL OUTER JOIN这种语法 可以改成 1+2 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w">
</span><span class="w"></span><span class="k">UNION</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 7 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="cm">/* MySQL不支持FULL OUTER JOIN这种语法 可以改成 4+5 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UNION</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">&lt;</span><span class="n">select_list</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableA</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">TableB</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="k">Key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="7索引">7.索引</h1>
<h2 id="71索引简介">7.1.索引简介</h2>
<blockquote>
<p>索引是什么？</p>
</blockquote>
<p>MySQL官方对索引的定义为：<strong>索引（INDEX）是帮助MySQL高效获取数据的数据结果。</strong></p>
<p>从而可以获得索引的本质：<strong>索引是排好序的快速查找数据结构。</strong></p>
<p>索引的目的在于提高查询效率，可以类比字典的目录。如果要查<code>mysql</code>这个这个单词，我们肯定要先定位到<code>m</code>字母，然后从上往下找<code>y</code>字母，再找剩下的<code>sql</code>。如果没有索引，那么可能需要<code>a---z</code>，这样全字典扫描，如果我想找<code>Java</code>开头的单词呢？如果我想找<code>Oracle</code>开头的单词呢？？？</p>
<p><strong>重点：索引会影响到MySQL查找(WHERE的查询条件)和排序(ORDER BY)两大功能！</strong></p>
<p><strong>除了数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。</strong></p>
<p>一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Linux下查看磁盘空间命令 df -h </span>
<span class="o">[</span>root@Ringo ~<span class="o">]</span><span class="c1"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda1        40G   16G   23G  41% /
devtmpfs        911M     <span class="m">0</span>  911M   0% /dev
tmpfs           920M     <span class="m">0</span>  920M   0% /dev/shm
tmpfs           920M  480K  920M   1% /run
tmpfs           920M     <span class="m">0</span>  920M   0% /sys/fs/cgroup
overlay          40G   16G   23G  41% 
</code></pre></td></tr></table>
</div>
</div><p>我们平时所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种数据结构的索引之外，还有哈希索引（Hash Index）等。</p>
<blockquote>
<p>索引的优势和劣势</p>
</blockquote>
<p>优势：</p>
<ul>
<li>查找：类似大学图书馆的书目索引，提高数据检索的效率，降低数据库的IO成本。</li>
<li>排序：通过索引対数据进行排序，降低数据排序的成本，降低了CPU的消耗。</li>
</ul>
<p>劣势：</p>
<ul>
<li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的。</li>
<li>虽然索引大大提高了查询速度，但是同时会降低表的更新速度，例如对表频繁的进行<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>。因为更新表的时候，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加的索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li>
<li>索引只是提高效率的一个因素，如果MySQL有大数据量的表，就需要花时间研究建立最优秀的索引。</li>
</ul>
<h2 id="72mysql索引分类">7.2.MySQL索引分类</h2>
<p>索引分类：</p>
<ul>
<li>单值索引：一个索引只包含单个列，一个表可以有多个单列索引。</li>
<li>唯一索引：索引列的值必须唯一，但是允许空值。</li>
<li>复合索引：一个索引包含多个字段。</li>
</ul>
<p><strong>建议：一张表建的索引最好不要超过5个！</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 基本语法 */</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 1、创建索引 [UNIQUE]可以省略*/</span><span class="w">
</span><span class="w"></span><span class="cm">/* 如果只写一个字段就是单值索引，写多个字段就是复合索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="p">[</span><span class="k">UNIQUE</span><span class="p">]</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">indexName</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tabName</span><span class="p">(</span><span class="n">columnName</span><span class="p">(</span><span class="k">length</span><span class="p">));</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2、删除索引 */</span><span class="w">
</span><span class="w"></span><span class="k">DROP</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tabName</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3、查看索引 */</span><span class="w">
</span><span class="w"></span><span class="cm">/* 加上\G就可以以列的形式查看了 不加\G就是以表的形式查看 */</span><span class="w">
</span><span class="w"></span><span class="k">SHOW</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tabName</span><span class="w"> </span><span class="err">\</span><span class="k">G</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用<code>ALTER</code>命令来为数据表添加索引</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 1、该语句添加一个主键，这意味着索引值必须是唯一的，并且不能为NULL */</span><span class="w">
</span><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tabName</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2、该语句创建索引的键值必须是唯一的(除了NULL之外，NULL可能会出现多次) */</span><span class="w">
</span><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tabName</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="n">indexName</span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3、该语句创建普通索引，索引值可以出现多次 */</span><span class="w">
</span><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tabName</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">indexName</span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 4、该语句指定了索引为FULLTEXT，用于全文检索 */</span><span class="w">
</span><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tabName</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">FULLTEXT</span><span class="w"> </span><span class="n">indexName</span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="73mysql索引数据结构">7.3MySQL索引数据结构</h2>
<p>索引数据结构：</p>
<ul>
<li><code>BTree</code>索引。</li>
<li><code>Hash</code>索引。</li>
<li><code>Full-text</code>全文索引。</li>
<li><code>R-Tree</code>索引。</li>
</ul>
<p><code>BTree</code>索引检索原理：</p>
<p><img src="https://img-blog.csdnimg.cn/20200801233134931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="BTree"></p>
<h2 id="74哪些情况需要建索引">7.4.哪些情况需要建索引</h2>
<ul>
<li>主键自动建立主键索引（唯一 + 非空）。</li>
<li>频繁作为查询条件的字段应该创建索引。</li>
<li>查询中与其他表关联的字段，外键关系建立索引。</li>
<li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度。</li>
<li>查询中统计或者分组字段（group by也和索引有关）。</li>
</ul>
<h2 id="75哪些情况不要建索引">7.5.哪些情况不要建索引</h2>
<ul>
<li>
<p>记录太少的表。</p>
</li>
<li>
<p>经常增删改的表。</p>
</li>
<li>
<p>频繁更新的字段不适合创建索引。</p>
</li>
<li>
<p>Where条件里用不到的字段不创建索引。</p>
</li>
<li>
<p>假如一个表有10万行记录，有一个字段A只有true和false两种值，并且每个值的分布概率大约为50%，那么对A字段建索引一般不会提高数据库的查询速度。索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。一个索引的选择性越接近于1，这个索引的效率就越高。</p>
</li>
</ul>
<h1 id="8性能分析">8.性能分析</h1>
<blockquote>
<p>1.Mysql中有专门的负责优化Select语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供它认为最优的执行计划（它认为最优的数据检索方式，不见得是DBA认为最优的，这部分很耗费时间）</p>
<p>2.当客户端向MySQL请求一条Query,命令解析器模块完成请求分类，区别出是SELECT并转发给MySQL Query OPtimizer时，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算， 直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整 等。然后分析Query中的Hint信息（如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果 没有Hint或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划。</p>
</blockquote>
<h2 id="81explain简介">8.1.EXPLAIN简介</h2>
<blockquote>
<p>EXPLAIN是什么？</p>
</blockquote>
<p>EXPLAIN：SQL的执行计划，使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理SQL语句的。</p>
<blockquote>
<p>EXPLAIN怎么使用？</p>
</blockquote>
<p>语法：<code>explain</code> + <code>SQL</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; explain <span class="k">select</span> * from pms_category <span class="se">\G</span><span class="p">;</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: pms_category
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: <span class="m">1425</span>
     filtered: 100.00
        Extra: NULL
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>EXPLAIN能干嘛？</p>
</blockquote>
<p>可以查看以下信息：</p>
<ul>
<li><code>id</code>：表的读取顺序。</li>
<li><code>select_type</code>：数据读取操作的操作类型。</li>
<li><code>possible_keys</code>：哪些索引可以使用。</li>
<li><code>key</code>：哪些索引被实际使用。</li>
<li><code>ref</code>：表之间的引用。</li>
<li><code>rows</code>：每张表有多少行被优化器查询。</li>
</ul>
<h2 id="82explain字段">8.2.EXPLAIN字段</h2>
<blockquote>
<p>id</p>
</blockquote>
<p><code>id</code>：表的读取和加载顺序。</p>
<p>值有以下三种情况：</p>
<ul>
<li><code>id</code>相同，执行顺序由上至下。</li>
<li><code>id</code>不同，如果是子查询，id的序号会递增，<strong>id值越大优先级越高，越先被执行。</strong></li>
<li><code>id</code>相同不同，同时存在。<strong>永远是id大的优先级最高，id相等的时候顺序执行。</strong></li>
</ul>
<blockquote>
<p>select_type</p>
</blockquote>
<p><code>select_type</code>：数据查询的类型，主要是用于区别，普通查询、联合查询、子查询等的复杂查询。</p>
<ul>
<li><code>SIMPLE</code>：简单的<code>SELECT</code>查询，查询中不包含子查询或者<code>UNION </code>。</li>
<li><code>PRIMARY</code>：查询中如果包含任何复杂的子部分，最外层查询则被标记为<code>PRIMARY</code>。</li>
<li><code>SUBQUERY</code>：在<code>SELECT</code>或者<code>WHERE</code>子句中包含了子查询。</li>
<li><code>DERIVED</code>：在<code>FROM</code>子句中包含的子查询被标记为<code>DERIVED(衍生)</code>，MySQL会递归执行这些子查询，把结果放在临时表中。</li>
<li><code>UNION</code>：如果第二个<code>SELECT</code>出现在<code>UNION</code>之后，则被标记为<code>UNION</code>；若<code>UNION</code>包含在<code>FROM</code>子句的子查询中，外层<code>SELECT</code>将被标记为<code>DERIVED</code>。</li>
<li><code>UNION RESULT</code>：从<code>UNION</code>表获取结果的<code>SELECT</code>。</li>
</ul>
<blockquote>
<p>type</p>
</blockquote>
<p><code>type</code>：访问类型排列。</p>
<p><strong>从最好到最差依次是：</strong><code>system</code>&gt;<code>const</code>&gt;<code>eq_ref</code>&gt;<code>ref</code>&gt;<code>range</code>&gt;<code>index</code>&gt;<code>ALL</code>。除了<code>ALL</code>没有用到索引，其他级别都用到索引了。</p>
<p>一般来说，得保证查询至少达到<code>range</code>级别，最好达到<code>ref</code>。</p>
<ul>
<li>
<p><code>system</code>：表只有一行记录（等于系统表），这是<code>const</code>类型的特例，平时不会出现，这个也可以忽略不计。</p>
</li>
<li>
<p><code>const</code>：表示通过索引一次就找到了，<code>const</code>用于比较<code>primary key</code>或者<code>unique</code>索引。因为只匹配一行数据，所以很快。如将主键置于<code>where</code>列表中，MySQL就能将该查询转化为一个常量。</p>
</li>
<li>
<p><code>eq_ref</code>：唯一性索引扫描，读取本表中和关联表表中的每行组合成的一行，查出来只有一条记录。除 了 <code>system</code> 和<code> const</code> 类型之外, 这是最好的联接类型。</p>
</li>
<li>
<p><code>ref</code>：非唯一性索引扫描，返回本表和关联表某个值匹配的所有行，查出来有多条记录。</p>
</li>
<li>
<p><code>range</code>：只检索给定范围的行，一般就是在<code>WHERE</code>语句中出现了<code>BETWEEN</code>、<code>&lt; &gt;</code>、<code>in</code>等的查询。这种范围扫描索引比全表扫描要好，因为它只需要开始于索引树的某一点，而结束于另一点，不用扫描全部索引。</p>
</li>
<li>
<p><code>index</code>：<code>Full Index Scan</code>，全索引扫描，<code>index</code>和<code>ALL</code>的区别为<code>index</code>类型只遍历索引树。<strong>也就是说虽然<code>ALL</code>和<code>index</code>都是读全表，但是<code>index</code>是从索引中读的，<code>ALL</code>是从磁盘中读取的。</strong></p>
</li>
<li>
<p><code>ALL</code>：<code>Full Table Scan</code>，没有用到索引，全表扫描。</p>
</li>
</ul>
<blockquote>
<p>possible_keys 和 key</p>
</blockquote>
<p><code>possible_keys</code>：显示可能应用在这张表中的索引，一个或者多个。查询涉及到的字段上若存在索引，则该索引将被列出，<strong>但不一定被查询实际使用。</strong></p>
<p><code>key</code>：实际使用的索引。如果为<code>NULL</code>，则没有使用索引。查询中如果使用了覆盖索引，则该索引仅仅出现在<code>key</code>列表中。</p>
<blockquote>
<p>key_len</p>
</blockquote>
<p><code>key_len</code>：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。<code>key_len</code>显示的值为索引字段的最大可能长度，并非实际使用长度，即<code>key_len</code>是根据表定义计算而得，不是通过表内检索出的。在不损失精度的情况下，长度越短越好。</p>
<p><code>key_len</code>计算规则：<strong><a href="https://blog.csdn.net/qq_34930488/article/details/102931490">https://blog.csdn.net/qq_34930488/article/details/102931490</a></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; desc pms_category<span class="p">;</span>
+---------------+------------+------+-----+---------+----------------+
<span class="p">|</span> Field         <span class="p">|</span> Type       <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+---------------+------------+------+-----+---------+----------------+
<span class="p">|</span> cat_id        <span class="p">|</span> bigint<span class="o">(</span>20<span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> name          <span class="p">|</span> char<span class="o">(</span>50<span class="o">)</span>   <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> parent_cid    <span class="p">|</span> bigint<span class="o">(</span>20<span class="o">)</span> <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> cat_level     <span class="p">|</span> int<span class="o">(</span>11<span class="o">)</span>    <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> show_status   <span class="p">|</span> tinyint<span class="o">(</span>4<span class="o">)</span> <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> sort          <span class="p">|</span> int<span class="o">(</span>11<span class="o">)</span>    <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> icon          <span class="p">|</span> char<span class="o">(</span>255<span class="o">)</span>  <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_unit  <span class="p">|</span> char<span class="o">(</span>50<span class="o">)</span>   <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_count <span class="p">|</span> int<span class="o">(</span>11<span class="o">)</span>    <span class="p">|</span> YES  <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+---------------+------------+------+-----+---------+----------------+
<span class="m">9</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>


mysql&gt; explain <span class="k">select</span> cat_id from pms_category where cat_id between <span class="m">10</span> and <span class="m">20</span> <span class="se">\G</span><span class="p">;</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: pms_category
   partitions: NULL
         type: range
possible_keys: PRIMARY
          key: PRIMARY  <span class="c1"># 用到了主键索引，通过查看表结构知道，cat_id是bigint类型，占用8个字节</span>
      key_len: <span class="m">8</span>        <span class="c1"># 这里只用到了cat_id主键索引，所以长度就是8！</span>
          ref: NULL
         rows: <span class="m">11</span>
     filtered: 100.00
        Extra: Using where<span class="p">;</span> Using index
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ref</p>
</blockquote>
<p><code>ref</code>：显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。</p>
<blockquote>
<p>rows</p>
</blockquote>
<p><code>rows</code>：根据表统计信息及索引选用情况，大致估算出找到所需的记录需要读取的行数。</p>
<blockquote>
<p>Extra</p>
</blockquote>
<p><code>Extra</code>：包含不适合在其他列中显示但十分重要的额外信息。</p>
<ul>
<li><code>Using filesort</code>：说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。<strong>MySQL中无法利用索引完成的排序操作成为&quot;文件内排序&quot;。</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 排序没有使用索引</span>
mysql&gt; explain <span class="k">select</span> name from pms_category where <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Tangs&#39;</span> order by cat_level <span class="se">\G</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: pms_category
   partitions: NULL
         type: ref
possible_keys: idx_name_parentCid_catLevel
          key: idx_name_parentCid_catLevel
      key_len: <span class="m">201</span>
          ref: const
         rows: <span class="m">1</span>
     filtered: 100.00
        Extra: Using where<span class="p">;</span> Using index<span class="p">;</span> Using filesort
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1">#~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~</span>
<span class="c1"># 排序使用到了索引</span>

mysql&gt; explain <span class="k">select</span> name from pms_category where <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Tangs&#39;</span> order by parent_cid,cat_level<span class="se">\G</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: pms_category
   partitions: NULL
         type: ref
possible_keys: idx_name_parentCid_catLevel
          key: idx_name_parentCid_catLevel
      key_len: <span class="m">201</span>
          ref: const
         rows: <span class="m">1</span>
     filtered: 100.00
        Extra: Using where<span class="p">;</span> Using index
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>Using temporary</code>：使用了临时表保存中间结果，MySQL在対查询结果排序时使用了临时表。常见于排序<code>order by</code>和分组查询<code>group by</code>。<strong>临时表対系统性能损耗很大。</strong></p>
</li>
<li>
<p><code>Using index</code>：表示相应的<code>SELECT</code>操作中使用了覆盖索引，避免访问了表的数据行，效率不错！如果同时出现<code>Using where</code>，表示索引被用来执行索引键值的查找；如果没有同时出现<code>Using where</code>，表明索引用来读取数据而非执行查找动作。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 覆盖索引</span>
<span class="c1"># 就是select的数据列只用从索引中就能够取得，不必从数据表中读取，换句话说查询列要被所使用的索引覆盖。</span>
<span class="c1"># 注意：如果要使用覆盖索引，一定不能写SELECT *，要写出具体的字段。</span>
mysql&gt; explain <span class="k">select</span> cat_id from pms_category <span class="se">\G</span><span class="p">;</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: pms_category
   partitions: NULL
         type: index
possible_keys: NULL       
          key: PRIMARY
      key_len: <span class="m">8</span>
          ref: NULL
         rows: <span class="m">1425</span>
     filtered: 100.00
        Extra: Using index   <span class="c1"># select的数据列只用从索引中就能够取得，不必从数据表中读取   </span>
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>Using where</code>：表明使用了<code>WHERE</code>过滤。</li>
<li><code>Using join buffer</code>：使用了连接缓存。</li>
<li><code>impossible where</code>：<code>WHERE</code>子句的值总是false，不能用来获取任何元组。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; explain <span class="k">select</span> name from pms_category where <span class="nv">name</span> <span class="o">=</span> <span class="s1">&#39;zs&#39;</span> and <span class="nv">name</span> <span class="o">=</span> <span class="s1">&#39;ls&#39;</span><span class="se">\G</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: NULL
   partitions: NULL
         type: NULL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: NULL
     filtered: NULL
        Extra: Impossible WHERE   <span class="c1"># 不可能字段同时查到两个名字</span>
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="9索引分析">9.索引分析</h1>
<h2 id="91单表索引分析">9.1.单表索引分析</h2>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;作者id&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分类id&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;被查看的次数&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;回帖的备注&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;标题&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;正文内容&#39;</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;文章&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">article</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">author_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">category_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comments</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">content</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>案例：查询<code>category_id</code>为1且<code>comments</code>大于1的情况下，<code>views</code>最多的<code>article_id</code>。</p>
</blockquote>
<p>1、编写SQL语句并查看SQL执行计划。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、sql语句</span>
SELECT id,author_id FROM article WHERE <span class="nv">category_id</span> <span class="o">=</span> <span class="m">1</span> AND comments &gt; <span class="m">1</span> ORDER BY views DESC LIMIT 1<span class="p">;</span>

<span class="c1"># 2、sql执行计划</span>
mysql&gt; EXPLAIN SELECT id,author_id FROM article WHERE <span class="nv">category_id</span> <span class="o">=</span> <span class="m">1</span> AND comments &gt; <span class="m">1</span> ORDER BY views DESC LIMIT 1<span class="se">\G</span>
*************************** 1. row ***************************
           id: <span class="m">1</span>
  select_type: SIMPLE
        table: article
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: <span class="m">5</span>
     filtered: 20.00
        Extra: Using where<span class="p">;</span> Using filesort  <span class="c1"># 产生了文件内排序，需要优化SQL</span>
<span class="m">1</span> row in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>2、创建索引<code>idx_article_ccv</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_article_ccv</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">article</span><span class="p">(</span><span class="n">category_id</span><span class="p">,</span><span class="n">comments</span><span class="p">,</span><span class="n">views</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>3、查看当前索引。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803134154162.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="show index"></p>
<p>4、查看现在SQL语句的执行计划。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803134549914.png" alt="explain"></p>
<p>我们发现，创建符合索引<code>idx_article_ccv</code>之后，虽然解决了全表扫描的问题，但是在<code>order by</code>排序的时候没有用到索引，MySQL居然还是用的<code>Using filesort</code>，为什么？</p>
<p>5、我们试试把SQL修改为<code>SELECT id,author_id FROM article WHERE category_id = 1 AND comments = 1 ORDER BY views DESC LIMIT 1;</code>看看SQL的执行计划。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803135228945.png" alt="explain"></p>
<p>推论：当<code>comments &gt; 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就用不上，但是当<code>comments = 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就可以用上！！！<strong>所以，范围之后的索引会失效。</strong></p>
<p>6、我们现在知道<strong>范围之后的索引会失效</strong>，原来的索引<code>idx_article_ccv</code>最后一个字段<code>views</code>会失效，那么我们如果删除这个索引，创建<code>idx_article_cv</code>索引呢？？？？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 创建索引 idx_article_cv */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_article_cv</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">article</span><span class="p">(</span><span class="n">category_id</span><span class="p">,</span><span class="n">views</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>查看当前的索引</p>
<p><img src="https://img-blog.csdnimg.cn/20200803140542912.png" alt="show index"></p>
<p>7、当前索引是<code>idx_article_cv</code>，来看一下SQL执行计划。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803140951803.png" alt="explain"></p>
<h2 id="92两表索引分析">9.2.两表索引分析</h2>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="k">class</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">book</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="k">class</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">card</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分类&#39;</span><span class="w"> 
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品类别&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">book</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">bookid</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">card</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分类&#39;</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;书籍&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>两表连接查询的SQL执行计划</p>
</blockquote>
<p>1、不创建索引的情况下，SQL的执行计划。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803143557187.png" alt="explain"></p>
<p><code>book</code>和<code>class</code>两张表都是没有使用索引，全表扫描，那么如果进行优化，索引是创建在<code>book</code>表还是创建在<code>class</code>表呢？下面进行大胆的尝试！</p>
<p>2、左表(<code>book</code>表)创建索引。</p>
<p>创建索引<code>idx_book_card</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 在book表创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_book_card</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">book</span><span class="p">(</span><span class="n">card</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在<code>book</code>表中有<code>idx_book_card</code>索引的情况下，查看SQL执行计划</p>
<p><img src="https://img-blog.csdnimg.cn/20200803144429349.png" alt="explain"></p>
<p>3、删除<code>book</code>表的索引，右表(<code>class</code>表)创建索引。</p>
<p>创建索引<code>idx_class_card</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 在class表创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_class_card</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">card</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在<code>class</code>表中有<code>idx_class_card</code>索引的情况下，查看SQL执行计划</p>
<p><img src="https://img-blog.csdnimg.cn/20200803145030597.png" alt="explain"></p>
<p><strong>由此可见，左连接将索引创建在右表上更合适，右连接将索引创建在左表上更合适。</strong></p>
<h2 id="93三张表索引分析">9.3.三张表索引分析</h2>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">phone</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">phone</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">phone_id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">card</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分类&#39;</span><span class="w"> 
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;手机&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>三表连接查询SQL优化</p>
</blockquote>
<p>1、不加任何索引，查看SQL执行计划。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803160631786.png" alt="explain"></p>
<p>2、根据两表查询优化的经验，左连接需要在右表上添加索引，所以尝试在<code>book</code>表和<code>phone</code>表上添加索引。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 在book表创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_book_card</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">book</span><span class="p">(</span><span class="n">card</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 在phone表上创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_phone_card</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">phone</span><span class="p">(</span><span class="n">card</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>再次执行SQL的执行计划</p>
<p><img src="https://img-blog.csdnimg.cn/20200803161013880.png" alt="explain"></p>
<h2 id="94结论">9.4.结论</h2>
<p><code>JOIN</code>语句的优化：</p>
<ul>
<li>尽可能减少<code>JOIN</code>语句中的<code>NestedLoop</code>（嵌套循环）的总次数：<strong>永远都是小的结果集驱动大的结果集</strong>。</li>
<li>优先优化<code>NestedLoop</code>的内层循环。</li>
<li>保证<code>JOIN</code>语句中被驱动表上<code>JOIN</code>条件字段已经被索引。</li>
<li>当无法保证被驱动表的<code>JOIN</code>条件字段被索引且内存资源充足的前提下，不要太吝惜<code>Join Buffer</code> 的设置。</li>
</ul>
<h1 id="10索引失效">10.索引失效</h1>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;姓名&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;年龄&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;职位&#39;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">add_time</span><span class="o">`</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;入职时间&#39;</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;员工记录表&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;Ringo&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;张三&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dev&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;李四&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dev&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_staffs_name_age_pos</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="101索引失效的情况">10.1.索引失效的情况</h2>
<ul>
<li>全值匹配我最爱。</li>
<li>最佳左前缀法则。</li>
<li>不在索引列上做任何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描。</li>
<li>索引中范围条件右边的字段会全部失效。</li>
<li>尽量使用覆盖索引（只访问索引的查询，索引列和查询列一致），减少<code>SELECT *</code>。</li>
<li>MySQL在使用<code>!=</code>或者<code>&lt;&gt;</code>的时候无法使用索引会导致全表扫描。</li>
<li><code>is null</code>、<code>is not null</code>也无法使用索引。</li>
<li><code>like</code>以通配符开头<code>%abc</code>索引失效会变成全表扫描（使用覆盖索引就不会全表扫描了）。</li>
<li>字符串不加单引号索引失效。</li>
<li>少用<code>or</code>，用它来连接时会索引失效。</li>
</ul>
<h2 id="102最佳左前缀法则">10.2.最佳左前缀法则</h2>
<blockquote>
<p>案例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name字段 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name, age字段 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引没用上，ALL全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引没用上，ALL全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name字段，pos字段索引失效 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>概念</p>
</blockquote>
<p><strong>最佳左前缀法则：如果索引是多字段的复合索引，要遵守最佳左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的字段。</strong></p>
<p><strong>口诀：带头大哥不能死，中间兄弟不能断。</strong></p>
<h2 id="103索引列上不计算">10.3.索引列上不计算</h2>
<blockquote>
<p>案例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 现在要查询`name` = &#39;Ringo&#39;的记录下面有两种方式来查询！</span>

<span class="c1"># 1、直接使用 字段 = 值的方式来计算</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>staffs<span class="sb">`</span> WHERE <span class="sb">`</span>name<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;Ringo&#39;</span><span class="p">;</span>
+----+-------+-----+---------+---------------------+
<span class="p">|</span> id <span class="p">|</span> name  <span class="p">|</span> age <span class="p">|</span> pos     <span class="p">|</span> add_time            <span class="p">|</span>
+----+-------+-----+---------+---------------------+
<span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> Ringo <span class="p">|</span>  <span class="m">18</span> <span class="p">|</span> manager <span class="p">|</span> 2020-08-03 08:30:39 <span class="p">|</span>
+----+-------+-----+---------+---------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 2、使用MySQL内置的函数</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>staffs<span class="sb">`</span> WHERE LEFT<span class="o">(</span><span class="sb">`</span>name<span class="sb">`</span>, 5<span class="o">)</span> <span class="o">=</span> <span class="s1">&#39;Ringo&#39;</span><span class="p">;</span>
+----+-------+-----+---------+---------------------+
<span class="p">|</span> id <span class="p">|</span> name  <span class="p">|</span> age <span class="p">|</span> pos     <span class="p">|</span> add_time            <span class="p">|</span>
+----+-------+-----+---------+---------------------+
<span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> Ringo <span class="p">|</span>  <span class="m">18</span> <span class="p">|</span> manager <span class="p">|</span> 2020-08-03 08:30:39 <span class="p">|</span>
+----+-------+-----+---------+---------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>我们发现以上两条SQL的执行结果都是一样的，但是执行效率有没有差距呢？？？</p>
<p>通过分析两条SQL的执行计划来分析性能。</p>
<p><img src="https://img-blog.csdnimg.cn/20200803171857325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="explain"></p>
<p><strong>由此可见，在索引列上进行计算，会使索引失效。</strong></p>
<p><strong>口诀：索引列上不计算。</strong></p>
<h2 id="104范围之后全失效">10.4.范围之后全失效</h2>
<blockquote>
<p>案例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 用到了idx_staffs_name_age_pos索引中的name，age字段，pos字段索引失效 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;张三&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dev&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>查看上述SQL的执行计划</p>
<p><img src="https://img-blog.csdnimg.cn/20200803173357787.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="explain"></p>
<p><strong>由此可知，查询范围的字段使用到了索引，但是范围之后的索引字段会失效。</strong></p>
<p><strong>口诀：范围之后全失效。</strong></p>
<h2 id="105覆盖索引尽量用">10.5.覆盖索引尽量用</h2>
<p>在写SQL的不要使用<code>SELECT *</code>，用什么字段就查询什么字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 没有用到覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><img src="https://img-blog.csdnimg.cn/20200803213031893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="使用覆盖索引"></p>
<p><strong>口诀：查询一定不用<code>*</code></strong>。</p>
<h2 id="106不等有时会失效">10.6.不等有时会失效</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 会使用到覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引失效 全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="107like百分加右边">10.7.like百分加右边</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 索引失效 全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%ing%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引失效 全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%ing&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用索引范围查询 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Rin%&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>口诀：<code>like</code>百分加右边。</strong></p>
<p>如果一定要使用<code>%like</code>，而且还要保证索引不失效，那么使用覆盖索引来编写SQL。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in%&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%na&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引失效 全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pos</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">add_time</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%in&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><img src="https://img-blog.csdnimg.cn/20200803220743206.png" alt="模糊查询百分号一定加前边"></p>
<p><strong>口诀：覆盖索引保两边。</strong></p>
<h2 id="108字符要加单引号">10.8.字符要加单引号</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 使用到了覆盖索引 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 索引失效 全表扫描 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">staffs</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这里name = 2000在MySQL中会发生强制类型转换，将数字转成字符串。</p>
<p><strong>口诀：字符要加单引号。</strong></p>
<h2 id="109索引相关题目">10.9.索引相关题目</h2>
<p><strong>假设index(a,b,c)</strong></p>
<table>
<thead>
<tr>
<th>Where语句</th>
<th>索引是否被使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>where a = 3</td>
<td>Y，使用到a</td>
</tr>
<tr>
<td>where a = 3 and b = 5</td>
<td>Y，使用到a，b</td>
</tr>
<tr>
<td>where a = 3 and b = 5</td>
<td>Y，使用到a，b，c</td>
</tr>
<tr>
<td>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td>
<td>N，没有用到a字段</td>
</tr>
<tr>
<td>where a = 3 and c = 5</td>
<td>使用到a，但是没有用到c，因为b断了</td>
</tr>
<tr>
<td>where a = 3 and b &gt; 4 and c = 5</td>
<td>使用到a，b，但是没有用到c，因为c在范围之后</td>
</tr>
<tr>
<td>where a = 3 and b like &lsquo;kk%&rsquo; and c = 4</td>
<td>Y，a，b，c都用到</td>
</tr>
<tr>
<td>where a = 3 and b like &lsquo;%kk&rsquo; and c = 4</td>
<td>只用到a</td>
</tr>
<tr>
<td>where a = 3 and b like &lsquo;%kk%&rsquo; and c = 4</td>
<td>只用到a</td>
</tr>
<tr>
<td>where a = 3 and b like &lsquo;k%kk%&rsquo; and c = 4</td>
<td>Y，a，b，c都用到</td>
</tr>
</tbody>
</table>
<h2 id="1010面试题分析">10.10.面试题分析</h2>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 创建表 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 插入数据 */</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">,</span><span class="s1">&#39;a2&#39;</span><span class="p">,</span><span class="s1">&#39;a3&#39;</span><span class="p">,</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span><span class="s1">&#39;a5&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">,</span><span class="s1">&#39;b22&#39;</span><span class="p">,</span><span class="s1">&#39;b3&#39;</span><span class="p">,</span><span class="s1">&#39;b4&#39;</span><span class="p">,</span><span class="s1">&#39;b5&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">,</span><span class="s1">&#39;c3&#39;</span><span class="p">,</span><span class="s1">&#39;c4&#39;</span><span class="p">,</span><span class="s1">&#39;c5&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;d1&#39;</span><span class="p">,</span><span class="s1">&#39;d2&#39;</span><span class="p">,</span><span class="s1">&#39;d3&#39;</span><span class="p">,</span><span class="s1">&#39;d4&#39;</span><span class="p">,</span><span class="s1">&#39;d5&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;e1&#39;</span><span class="p">,</span><span class="s1">&#39;e2&#39;</span><span class="p">,</span><span class="s1">&#39;e3&#39;</span><span class="p">,</span><span class="s1">&#39;e4&#39;</span><span class="p">,</span><span class="s1">&#39;e5&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 创建复合索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_test03_c1234</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>题目</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 最好索引怎么创建的，就怎么用，按照顺序使用，避免让MySQL再自己去翻译一次 */</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 1.全值匹配 用到索引c1 c2 c3 c4全字段 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a3&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a3&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a3&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 4.用到索引c1 c2 c3字段，c4字段失效，范围之后全失效 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;a3&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 5.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a3&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 
</span><span class="cm">   6.用到了索引c1 c2 c3三个字段, c1和c2两个字段用于查找,  c3字段用于排序了但是没有统计到key_len中，c4字段失效
</span><span class="cm">*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 7.用到了索引c1 c2 c3三个字段，c1和c2两个字段用于查找, c3字段用于排序了但是没有统计到key_len中*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 
</span><span class="cm">   8.用到了索引c1 c2两个字段，c4失效，c1和c2两个字段用于查找，c4字段排序产生了Using filesort说明排序没有用到c4字段 
</span><span class="cm">*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 9.用到了索引c1 c2 c3三个字段，c1用于查找，c2和c3用于排序 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a5&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 10.用到了c1一个字段，c1用于查找，c3和c2两个字段索引失效，产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a5&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 11.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w">  </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 12.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w">  </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a5&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 
</span><span class="cm">   13.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 没有产生Using filesort 
</span><span class="cm">      因为之前c2这个字段已经确定了是&#39;a2&#39;了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！
</span><span class="cm">      所以没有产生Using filesort 和(10)进行对比学习！
</span><span class="cm">*/</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a2&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c5</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a5&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* GROUP BY 表面上是叫做分组，但是分组之前必定排序。 */</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 14.用到c1 c2 c3三个字段，c1用于查找，c2 c3用于排序，c4失效 */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 15.用到c1这一个字段，c4失效，c2和c3排序失效产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">test03</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">`</span><span class="n">c4</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a4&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">c2</span><span class="o">`</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>GROUP BY</code>基本上都需要进行排序，索引优化几乎和<code>ORDER BY</code>一致，但是<code>GROUP BY</code>会有临时表的产生。</p>
<h2 id="1011总结">10.11.总结</h2>
<p>索引优化的一般性建议：</p>
<ul>
<li>对于单值索引，尽量选择针对当前<code>query</code>过滤性更好的索引。</li>
<li>在选择复合索引的时候，当前<code>query</code>中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择复合索引的时候，尽量选择可以能够包含当前<code>query</code>中的<code>where</code>子句中更多字段的索引。</li>
<li>尽可能通过分析统计信息和调整<code>query</code>的写法来达到选择合适索引的目的。</li>
</ul>
<p>口诀：</p>
<ul>
<li>带头大哥不能死。</li>
<li>中间兄弟不能断。</li>
<li>索引列上不计算。</li>
<li>范围之后全失效。</li>
<li>覆盖索引尽量用。</li>
<li>不等有时会失效。</li>
<li>like百分加右边。</li>
<li>字符要加单引号。</li>
<li>一般SQL少用or。</li>
</ul>
<h1 id="11分析慢sql的步骤">11.分析慢SQL的步骤</h1>
<p>分析：</p>
<p>1、观察，至少跑1天，看看生产的慢SQL情况。</p>
<p>2、开启慢查询日志，设置阈值，比如超过5秒钟的就是慢SQL，并将它抓取出来。</p>
<p>3、explain + 慢SQL分析。</p>
<p>4、show Profile。</p>
<p>5、运维经理 OR DBA，进行MySQL数据库服务器的参数调优。</p>
<p>总结（大纲）：</p>
<p>1、慢查询的开启并捕获。</p>
<p>2、explain + 慢SQL分析。</p>
<p>3、show Profile查询SQL在MySQL数据库中的执行细节和生命周期情况。</p>
<p>4、MySQL数据库服务器的参数调优。</p>
<h1 id="12查询优化">12.查询优化</h1>
<h2 id="121小表驱动大表">12.1.小表驱动大表</h2>
<blockquote>
<p>优化原则：对于MySQL数据库而言，永远都是小表驱动大表。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">* 举个例子：可以使用嵌套的for循环来理解小表驱动大表。
</span><span class="cm">* 以下两个循环结果都是一样的，但是对于MySQL来说不一样，
</span><span class="cm">* 第一种可以理解为，和MySQL建立5次连接每次查询1000次。
</span><span class="cm">* 第一种可以理解为，和MySQL建立1000次连接每次查询5次。
</span><span class="cm">*/</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">1000</span><span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
        
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
</span><span class="c1"></span><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">1000</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
        
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>IN和EXISTS</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 优化原则：小表驱动大表，即小的数据集驱动大的数据集 */</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* IN适合B表比A表数据小的情况*/</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">A</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">B</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* EXISTS适合B表比A表数据大的情况 */</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">A</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">B</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">B</span><span class="o">`</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">A</span><span class="o">`</span><span class="p">.</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>EXISTS：</strong></p>
<ul>
<li>语法：<code>SELECT....FROM tab WHERE EXISTS(subquery);</code>该语法可以理解为：</li>
<li>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（<code>true</code>或是<code>false</code>）来决定主查询的数据结果是否得以保留。</li>
</ul>
<p><strong>提示：</strong></p>
<ul>
<li><code>EXISTS(subquery)</code>子查询只返回<code>true</code>或者<code>false</code>，因此子查询中的<code>SELECT *</code>可以是<code>SELECT 1 OR SELECT X</code>，它们并没有区别。</li>
<li><code>EXISTS(subquery)</code>子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担心效率问题，可进行实际检验以确定是否有效率问题。</li>
<li><code>EXISTS(subquery)</code>子查询往往也可以用条件表达式，其他子查询或者<code>JOIN</code>替代，何种最优需要具体问题具体分析。</li>
</ul>
<h2 id="122order-by优化">12.2.ORDER BY优化</h2>
<blockquote>
<p>数据准备</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w">
</span><span class="w"></span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">18</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 创建索引 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_talA_age_birth</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>案例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 1.使用索引进行排序了 不会产生Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2.使用索引进行排序了 不会产生Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3.没有使用索引进行排序 产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 4.没有使用索引进行排序 产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 5.没有使用索引进行排序 产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 6.没有使用索引进行排序 产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2020-08-04 07:42:21&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 7.使用索引进行排序了 不会产生Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2020-08-04 07:42:21&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 8.没有使用索引进行排序 产生了Using filesort */</span><span class="w">
</span><span class="w"></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">talA</span><span class="o">`</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">birth</span><span class="o">`</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>ORDER BY</code>子句，尽量使用索引排序，避免使用<code>Using filesort</code>排序。</p>
<p>MySQL支持两种方式的排序，<code>FileSort</code>和<code>Index</code>，<code>Index</code>的效率高，它指MySQL扫描索引本身完成排序。<code>FileSort</code>方式效率较低。</p>
<p><code>ORDER BY</code>满足两情况，会使用<code>Index</code>方式排序：</p>
<ul>
<li><code>ORDER BY</code>语句使用索引最左前列。</li>
<li>使用<code>WHERE</code>子句与<code>ORDER BY</code>子句条件列组合满足索引最左前列。</li>
</ul>
<p><strong>结论：尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀原则。</strong></p>
<blockquote>
<p>如果不在索引列上，File Sort有两种算法：MySQL就要启动双路排序算法和单路排序算法</p>
</blockquote>
<p>1、双路排序算法：MySQL4.1之前使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和<code>ORDER BY</code>列，対他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。<strong>一句话，从磁盘取排序字段，在<code>buffer</code>中进行排序，再从磁盘取其他字段。</strong></p>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在MySQL4.1之后，出现了改进的算法，就是单路排序算法。</p>
<p>2、单路排序算法：从磁盘读取查询需要的所有列，按照<code>ORDER BY</code>列在<code>buffer</code>対它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</p>
<p>由于单路排序算法是后出的，总体而言效率好过双路排序算法。</p>
<p>但是单路排序算法有问题：如果<code>SortBuffer</code>缓冲区太小，导致从磁盘中读取所有的列不能完全保存在<code>SortBuffer</code>缓冲区中，这时候单路复用算法就会出现问题，反而性能不如双路复用算法。</p>
<p><strong>单路复用算法的优化策略：</strong></p>
<ul>
<li>增大<code>sort_buffer_size</code>参数的设置。</li>
<li>增大<code>max_length_for_sort_data</code>参数的设置。</li>
</ul>
<p><strong>提高ORDER BY排序的速度：</strong></p>
<ul>
<li>
<p><code>ORDER BY</code>时使用<code>SELECT *</code>是大忌，查什么字段就写什么字段，这点非常重要。在这里的影响是：</p>
<ul>
<li>当查询的字段大小总和小于<code>max_length_for_sort_data</code>而且排序字段不是<code>TEXT|BLOB</code>类型时，会使用单路排序算法，否则使用多路排序算法。</li>
<li>两种排序算法的数据都有可能超出<code>sort_buffer</code>缓冲区的容量，超出之后，会创建<code>tmp</code>临时文件进行合并排序，导致多次IO，但是单路排序算法的风险会更大一些，所以要增大<code>sort_buffer_size</code>参数的设置。</li>
</ul>
</li>
<li>
<p>尝试提高<code>sort_buffer_size</code>：不管使用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。</p>
</li>
<li>
<p>尝试提高<code>max_length_for_sort_data</code>：提高这个参数，会增加用单路排序算法的概率。但是如果设置的太高，数据总容量<code>sort_buffer_size</code>的概率就增大，明显症状是高的磁盘IO活动和低的处理器使用率。</p>
</li>
</ul>
<h2 id="123gorup-by优化">12.3.GORUP BY优化</h2>
<ul>
<li>
<p><code>GROUP BY</code>实质是先排序后进行分组，遵照索引建的最佳左前缀。</p>
</li>
<li>
<p>当无法使用索引列时，会使用<code>Using filesort</code>进行排序，增大<code>max_length_for_sort_data</code>参数的设置和增大<code>sort_buffer_size</code>参数的设置，会提高性能。</p>
</li>
<li>
<p><code>WHERE</code>执行顺序高于<code>HAVING</code>，能写在<code>WHERE</code>限定条件里的就不要写在<code>HAVING</code>中了。</p>
</li>
</ul>
<h2 id="124总结">12.4.总结</h2>
<p><strong>为排序使用索引</strong></p>
<ul>
<li>MySQL两种排序方式：<code>Using filesort</code>和<code>Index</code>扫描有序索引排序。</li>
<li>MySQL能为排序与查询使用相同的索引，创建的索引既可以用于排序也可以用于查询。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="cm">/* 创建a b c三个字段的索引 */</span><span class="w">
</span><span class="w"></span><span class="n">idx_table_a_b_c</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 1.ORDER BY 能使用索引最左前缀 */</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2.如果WHERE子句中使用索引的最左前缀定义为常量，则ORDER BY能使用索引 */</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Tangs&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ringo&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 3.不能使用索引进行排序 */</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 排序不一致 */</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 丢失a字段索引 */</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 丢失b字段索引 */</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">   </span><span class="cm">/* d字段不是索引的一部分 */</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(...)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 对于排序来说，多个相等条件(a=1 or a=2)也是范围查询 */</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="13慢查询日志">13.慢查询日志</h1>
<h2 id="131基本介绍">13.1.基本介绍</h2>
<blockquote>
<p>慢查询日志是什么？</p>
</blockquote>
<ul>
<li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间超过<code>long_query_time</code>值的SQL，则会被记录到慢查询日志中。</li>
<li><code>long_query_time</code>的默认值为10，意思是运行10秒以上的语句。</li>
<li>由慢查询日志来查看哪些SQL超出了我们的最大忍耐时间值，比如一条SQL执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒钟的SQL，结合之前<code>explain</code>进行全面分析。</li>
</ul>
<blockquote>
<p>特别说明</p>
</blockquote>
<p>**默认情况下，MySQL数据库没有开启慢查询日志，**需要我们手动来设置这个参数。</p>
<p><strong>当然，如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p>
<blockquote>
<p>查看慢查询日志是否开以及如何开启</p>
</blockquote>
<ul>
<li>
<p>查看慢查询日志是否开启：<code>SHOW VARIABLES LIKE '%slow_query_log%';</code>。</p>
</li>
<li>
<p>开启慢查询日志：<code>SET GLOBAL slow_query_log = 1;</code>。<strong>使用该方法开启MySQL的慢查询日志只对当前数据库生效，如果MySQL重启后会失效。</strong></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、查看慢查询日志是否开启</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s1">&#39;%slow_query_log%&#39;</span><span class="p">;</span>
+---------------------+--------------------------------------+
<span class="p">|</span> Variable_name       <span class="p">|</span> Value                                <span class="p">|</span>
+---------------------+--------------------------------------+
<span class="p">|</span> slow_query_log      <span class="p">|</span> OFF                                  <span class="p">|</span>
<span class="p">|</span> slow_query_log_file <span class="p">|</span> /var/lib/mysql/1dcb5644392c-slow.log <span class="p">|</span>
+---------------------+--------------------------------------+
<span class="m">2</span> rows in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>

<span class="c1"># 2、开启慢查询日志</span>
mysql&gt; SET GLOBAL <span class="nv">slow_query_log</span> <span class="o">=</span> 1<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果要使慢查询日志永久开启，需要修改<code>my.cnf</code>文件，在<code>[mysqld]</code>下增加修改参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># my.cnf</span>
<span class="o">[</span>mysqld<span class="o">]</span>
<span class="c1"># 1.这个是开启慢查询。注意ON需要大写</span>
<span class="nv">slow_query_log</span><span class="o">=</span>ON  

<span class="c1"># 2.这个是存储慢查询的日志文件。这个文件不存在的话，需要自己创建</span>
<span class="nv">slow_query_log_file</span><span class="o">=</span>/var/lib/mysql/slow.log
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>开启了慢查询日志后，什么样的SQL才会被记录到慢查询日志里面呢？</p>
</blockquote>
<p>这个是由参数<code>long_query_time</code>控制的，默认情况下<code>long_query_time</code>的值为10秒。</p>
<p>MySQL中查看<code>long_query_time</code>的时间：<code>SHOW VARIABLES LIKE 'long_query_time%';</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 查看long_query_time 默认是10秒</span>
<span class="c1"># 只有SQL的执行时间&gt;10才会被记录</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s1">&#39;long_query_time%&#39;</span><span class="p">;</span>
+-----------------+-----------+
<span class="p">|</span> Variable_name   <span class="p">|</span> Value     <span class="p">|</span>
+-----------------+-----------+
<span class="p">|</span> long_query_time <span class="p">|</span> 10.000000 <span class="p">|</span>
+-----------------+-----------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>修改<code>long_query_time</code>的时间，需要在<code>my.cnf</code>修改配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>mysqld<span class="o">]</span>
<span class="c1"># 这个是设置慢查询的时间，我设置的为1秒</span>
<span class="nv">long_query_time</span><span class="o">=</span><span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>查新慢查询日志的总记录条数：<code>SHOW GLOBAL STATUS LIKE '%Slow_queries%';</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; SHOW GLOBAL STATUS LIKE <span class="s1">&#39;%Slow_queries%&#39;</span><span class="p">;</span>
+---------------+-------+
<span class="p">|</span> Variable_name <span class="p">|</span> Value <span class="p">|</span>
+---------------+-------+
<span class="p">|</span> Slow_queries  <span class="p">|</span> <span class="m">3</span>     <span class="p">|</span>
+---------------+-------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="132日志分析工具">13.2.日志分析工具</h2>
<p>日志分析工具<code>mysqldumpslow</code>：在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具<code>mysqldumpslow</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、mysqldumpslow --help 来查看mysqldumpslow的帮助信息</span>
root@1dcb5644392c:/usr/bin# mysqldumpslow --help
Usage: mysqldumpslow <span class="o">[</span> OPTS... <span class="o">]</span> <span class="o">[</span> LOGS... <span class="o">]</span>

Parse and summarize the MySQL slow query log. Options are

  --verbose    verbose
  --debug      debug
  --help       write this text to standard output

  -v           verbose
  -d           debug
  -s ORDER     what to sort by <span class="o">(</span>al, at, ar, c, l, r, t<span class="o">)</span>, <span class="s1">&#39;at&#39;</span> is default  <span class="c1"># 按照何种方式排序</span>
                al: average lock <span class="nb">time</span> <span class="c1"># 平均锁定时间</span>
                ar: average rows sent <span class="c1"># 平均返回记录数</span>
                at: average query <span class="nb">time</span> <span class="c1"># 平均查询时间</span>
                 c: count  <span class="c1"># 访问次数</span>
                 l: lock <span class="nb">time</span>  <span class="c1"># 锁定时间</span>
                 r: rows sent  <span class="c1"># 返回记录</span>
                 t: query <span class="nb">time</span>  <span class="c1"># 查询时间 </span>
  -r           reverse the sort order <span class="o">(</span>largest last instead of first<span class="o">)</span>
  -t NUM       just show the top n queries  <span class="c1"># 返回前面多少条记录</span>
  -a           don<span class="s1">&#39;t abstract all numbers to N and strings to &#39;</span>S<span class="s1">&#39;
</span><span class="s1">  -n NUM       abstract numbers with at least n digits within names
</span><span class="s1">  -g PATTERN   grep: only consider stmts that include this string  
</span><span class="s1">  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),
</span><span class="s1">               default is &#39;</span>*<span class="s1">&#39;, i.e. match all
</span><span class="s1">  -i NAME      name of server instance (if using mysql.server startup script)
</span><span class="s1">  -l           don&#39;</span>t subtract lock <span class="nb">time</span> from total <span class="nb">time</span>
  
<span class="c1"># 2、 案例</span>
<span class="c1"># 2.1、得到返回记录集最多的10个SQL</span>
mysqldumpslow -s r -t <span class="m">10</span> /var/lib/mysql/slow.log
 
<span class="c1"># 2.2、得到访问次数最多的10个SQL</span>
mysqldumpslow -s c -t <span class="m">10</span> /var/lib/mysql/slow.log
 
<span class="c1"># 2.3、得到按照时间排序的前10条里面含有左连接的查询语句</span>
mysqldumpslow -s t -t <span class="m">10</span> -g <span class="s2">&#34;left join&#34;</span> /var/lib/mysql/slow.log

<span class="c1"># 2.4、另外建议使用这些命令时结合|和more使用，否则出现爆屏的情况</span>
mysqldumpslow -s r -t <span class="m">10</span> /var/lib/mysql/slow.log <span class="p">|</span> more
</code></pre></td></tr></table>
</div>
</div><h1 id="14批量插入数据脚本">14.批量插入数据脚本</h1>
<h2 id="141环境准备">14.1.环境准备</h2>
<blockquote>
<p>1、建表SQL。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="cm">/* 1.dept表 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">dept</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">deptno</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;部门id&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">dname</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;部门名字&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">loc</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;部门地址&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="n">COMMENT</span><span class="o">=</span><span class="s1">&#39;部门表&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cm">/* 2.emp表 */</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">emp</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">empno</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;员工编号&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">ename</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;员工名字&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">job</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;职位&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">mgr</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;上级编号&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">hiredata</span><span class="o">`</span><span class="w"> </span><span class="kt">date</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;入职时间&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">sal</span><span class="o">`</span><span class="w"> </span><span class="kt">decimal</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;薪水&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">comm</span><span class="o">`</span><span class="w"> </span><span class="kt">decimal</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;分红&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">deptno</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;部门id&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="n">COMMENT</span><span class="o">=</span><span class="s1">&#39;员工表&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、由于开启过慢查询日志，开启了<code>bin-log</code>，我们就必须为<code>function</code>指定一个参数，否则使用函数会报错。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 在mysql中设置 </span>
<span class="c1"># log_bin_trust_function_creators 默认是关闭的 需要手动开启</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s1">&#39;log_bin_trust_function_creators&#39;</span><span class="p">;</span>
+---------------------------------+-------+
<span class="p">|</span> Variable_name                   <span class="p">|</span> Value <span class="p">|</span>
+---------------------------------+-------+
<span class="p">|</span> log_bin_trust_function_creators <span class="p">|</span> OFF   <span class="p">|</span>
+---------------------------------+-------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; SET GLOBAL <span class="nv">log_bin_trust_function_creators</span><span class="o">=</span>1<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>上述修改方式MySQL重启后会失败，在<code>my.cnf</code>配置文件下修改永久有效。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>mysqld<span class="o">]</span>
<span class="nv">log_bin_trust_function_creators</span><span class="o">=</span>ON
</code></pre></td></tr></table>
</div>
</div><h2 id="142创建函数">14.2.创建函数</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 1、函数：随机产生字符串
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="nf">rand_string</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="kt">INT</span><span class="p">)</span><span class="w"> </span><span class="n">RETURNS</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="n">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">chars_str</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;abcdefghijklmnopqrstuvwsyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">return_str</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">WHILE</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">DO</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">return_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CONCAT</span><span class="p">(</span><span class="n">return_str</span><span class="p">,</span><span class="nf">SUBSTRING</span><span class="p">(</span><span class="n">chars_str</span><span class="p">,</span><span class="nf">FLOOR</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nf">RAND</span><span class="p">()</span><span class="o">*</span><span class="mi">52</span><span class="p">),</span><span class="mi">1</span><span class="p">));</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">return_str</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 2、函数：随机产生部门编号
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="nf">rand_num</span><span class="p">()</span><span class="w"> </span><span class="n">RETURNS</span><span class="w"> </span><span class="kt">INT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="n">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">FLOOR</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">RAND</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="143创建存储过程">14.3.创建存储过程</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 1、函数：向dept表批量插入
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="nf">insert_dept</span><span class="p">(</span><span class="k">IN</span><span class="w"> </span><span class="n">START</span><span class="w"> </span><span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="k">IN</span><span class="w"> </span><span class="n">max_num</span><span class="w"> </span><span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="n">BEGIN</span><span class="w">
</span><span class="w"></span><span class="k">DECLARE</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">autocommit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">REPEAT</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nf">dept</span><span class="p">(</span><span class="n">deptno</span><span class="p">,</span><span class="n">dname</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">((</span><span class="n">START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="nf">rand_string</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="nf">rand_string</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span><span class="w">
</span><span class="w">    </span><span class="n">UNTIL</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_num</span><span class="w">
</span><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">REPEAT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">COMMIT</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 2、函数：向emp表批量插入
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="nf">insert_emp</span><span class="p">(</span><span class="k">IN</span><span class="w"> </span><span class="n">START</span><span class="w"> </span><span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="k">IN</span><span class="w"> </span><span class="n">max_num</span><span class="w"> </span><span class="kt">INT</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="n">BEGIN</span><span class="w">
</span><span class="w"></span><span class="k">DECLARE</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">autocommit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">REPEAT</span><span class="w">
</span><span class="w">    </span><span class="kt">SET</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nf">emp</span><span class="p">(</span><span class="n">empno</span><span class="p">,</span><span class="n">ename</span><span class="p">,</span><span class="n">job</span><span class="p">,</span><span class="n">mgr</span><span class="p">,</span><span class="n">hiredata</span><span class="p">,</span><span class="n">sal</span><span class="p">,</span><span class="n">comm</span><span class="p">,</span><span class="n">deptno</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">((</span><span class="n">START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="nf">rand_string</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;SALESMAN&#39;</span><span class="p">,</span><span class="mi">0001</span><span class="p">,</span><span class="nf">CURDATE</span><span class="p">(),</span><span class="mi">2000</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="nf">rand_num</span><span class="p">());</span><span class="w">
</span><span class="w">    </span><span class="n">UNTIL</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_num</span><span class="w">
</span><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">REPEAT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">COMMIT</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="144调用存储过程">14.4.调用存储过程</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 1、调用存储过程向dept表插入10个部门。
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">CALL</span><span class="w"> </span><span class="nf">insert_dept</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 2、调用存储过程向emp表插入50万条数据。
</span><span class="c1"></span><span class="n">DELIMITER</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">CALL</span><span class="w"> </span><span class="nf">insert_emp</span><span class="p">(</span><span class="mi">100001</span><span class="p">,</span><span class="mi">500000</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="15show-profile">15.Show Profile</h1>
<blockquote>
<p>Show Profile是什么？</p>
</blockquote>
<p><code>Show Profile</code>：MySQL提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量。<strong>默认情况下，参数处于关闭状态，并保存最近15次的运行结果。</strong></p>
<blockquote>
<p>分析步骤</p>
</blockquote>
<p>1、是否支持，看看当前的MySQL版本是否支持。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 查看Show Profile功能是否开启</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s1">&#39;profiling&#39;</span><span class="p">;</span>
+---------------+-------+
<span class="p">|</span> Variable_name <span class="p">|</span> Value <span class="p">|</span>
+---------------+-------+
<span class="p">|</span> profiling     <span class="p">|</span> OFF   <span class="p">|</span>
+---------------+-------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>2、开启<code>Show Profile</code>功能，默认是关闭的，使用前需要开启。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 开启Show Profile功能</span>
mysql&gt; SET <span class="nv">profiling</span><span class="o">=</span>ON<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>3、运行SQL</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">emp</span><span class="o">`</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`%</span><span class="mi">10</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">150000</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">emp</span><span class="o">`</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`%</span><span class="mi">20</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、查看结果，执行<code>SHOW PROFILES;</code></p>
<p><code>Duration</code>：持续时间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; SHOW PROFILES<span class="p">;</span>
+----------+------------+---------------------------------------------------+
<span class="p">|</span> Query_ID <span class="p">|</span> Duration   <span class="p">|</span> Query                                             <span class="p">|</span>
+----------+------------+---------------------------------------------------+
<span class="p">|</span>        <span class="m">1</span> <span class="p">|</span> 0.00156100 <span class="p">|</span> SHOW VARIABLES LIKE <span class="s1">&#39;profiling&#39;</span>                   <span class="p">|</span>
<span class="p">|</span>        <span class="m">2</span> <span class="p">|</span> 0.56296725 <span class="p">|</span> SELECT * FROM <span class="sb">`</span>emp<span class="sb">`</span> GROUP BY <span class="sb">`</span>id<span class="sb">`</span>%10 LIMIT <span class="m">150000</span> <span class="p">|</span>
<span class="p">|</span>        <span class="m">3</span> <span class="p">|</span> 0.52105825 <span class="p">|</span> SELECT * FROM <span class="sb">`</span>emp<span class="sb">`</span> GROUP BY <span class="sb">`</span>id<span class="sb">`</span>%10 LIMIT <span class="m">150000</span> <span class="p">|</span>
<span class="p">|</span>        <span class="m">4</span> <span class="p">|</span> 0.51279775 <span class="p">|</span> SELECT * FROM <span class="sb">`</span>emp<span class="sb">`</span> GROUP BY <span class="sb">`</span>id<span class="sb">`</span>%20 ORDER BY <span class="m">5</span>   <span class="p">|</span>
+----------+------------+---------------------------------------------------+
<span class="m">4</span> rows in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>5、诊断SQL，<code>SHOW PROFILE cpu,block io FOR QUERY Query_ID;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 这里的3是第四步中的Query_ID。</span>
<span class="c1"># 可以在SHOW PROFILE中看到一条SQL中完整的生命周期。</span>
mysql&gt; SHOW PROFILE cpu,block io FOR QUERY 3<span class="p">;</span>
+----------------------+----------+----------+------------+--------------+---------------+
<span class="p">|</span> Status               <span class="p">|</span> Duration <span class="p">|</span> CPU_user <span class="p">|</span> CPU_system <span class="p">|</span> Block_ops_in <span class="p">|</span> Block_ops_out <span class="p">|</span>
+----------------------+----------+----------+------------+--------------+---------------+
<span class="p">|</span> starting             <span class="p">|</span> 0.000097 <span class="p">|</span> 0.000090 <span class="p">|</span>   0.000002 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> checking permissions <span class="p">|</span> 0.000010 <span class="p">|</span> 0.000009 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> Opening tables       <span class="p">|</span> 0.000039 <span class="p">|</span> 0.000058 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> init                 <span class="p">|</span> 0.000046 <span class="p">|</span> 0.000046 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> System lock          <span class="p">|</span> 0.000011 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> optimizing           <span class="p">|</span> 0.000005 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> statistics           <span class="p">|</span> 0.000023 <span class="p">|</span> 0.000037 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> preparing            <span class="p">|</span> 0.000014 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> Creating tmp table   <span class="p">|</span> 0.000041 <span class="p">|</span> 0.000053 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> Sorting result       <span class="p">|</span> 0.000005 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> executing            <span class="p">|</span> 0.000003 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> Sending data         <span class="p">|</span> 0.520620 <span class="p">|</span> 0.516267 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> Creating sort index  <span class="p">|</span> 0.000060 <span class="p">|</span> 0.000051 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> end                  <span class="p">|</span> 0.000006 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> query end            <span class="p">|</span> 0.000011 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> removing tmp table   <span class="p">|</span> 0.000006 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> query end            <span class="p">|</span> 0.000004 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> closing tables       <span class="p">|</span> 0.000009 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> freeing items        <span class="p">|</span> 0.000032 <span class="p">|</span> 0.000064 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
<span class="p">|</span> cleaning up          <span class="p">|</span> 0.000019 <span class="p">|</span> 0.000000 <span class="p">|</span>   0.000000 <span class="p">|</span>            <span class="m">0</span> <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
+----------------------+----------+----------+------------+--------------+---------------+
<span class="m">20</span> rows in set, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Show Profile</code>查询参数备注：</p>
<ul>
<li><code>ALL</code>：显示所有的开销信息。</li>
<li><code>BLOCK IO</code>：显示块IO相关开销（通用）。</li>
<li><code>CONTEXT SWITCHES</code>：上下文切换相关开销。</li>
<li><code>CPU</code>：显示CPU相关开销信息（通用）。</li>
<li><code>IPC</code>：显示发送和接收相关开销信息。</li>
<li><code>MEMORY</code>：显示内存相关开销信息。</li>
<li><code>PAGE FAULTS</code>：显示页面错误相关开销信息。</li>
<li><code>SOURCE</code>：显示和Source_function。</li>
<li><code>SWAPS</code>：显示交换次数相关开销的信息。</li>
</ul>
<p>6、<code>Show Profile</code>查询列表，日常开发需要注意的结论：</p>
<ul>
<li><code>converting HEAP to MyISAM</code>：查询结果太大，内存都不够用了，往磁盘上搬了。</li>
<li><code>Creating tmp table</code>：创建临时表（拷贝数据到临时表，用完再删除），非常耗费数据库性能。</li>
<li><code>Copying to tmp table on disk</code>：把内存中的临时表复制到磁盘，危险！！！</li>
<li><code>locked</code>：死锁。</li>
</ul>
<h1 id="16表锁偏读">16.表锁(偏读)</h1>
<p><strong>表锁特点：</strong></p>
<ul>
<li>表锁偏向<code>MyISAM</code>存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发度最低。</li>
</ul>
<h2 id="161环境准备">16.1.环境准备</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 1、创建表
</span><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">MYISAM</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="n">COMMENT</span><span class="o">=</span><span class="s1">&#39;测试表锁&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 2、插入数据
</span><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;ZhangSan&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;LiSi&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;WangWu&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;ZhaoLiu&#39;</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="162锁表的命令">16.2.锁表的命令</h2>
<blockquote>
<p>1、查看数据库表锁的命令。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 查看数据库表锁的命令
</span><span class="c1"></span><span class="k">SHOW</span><span class="w"> </span><span class="n">OPEN</span><span class="w"> </span><span class="kp">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、给<code>mylock</code>表上读锁，给<code>book</code>表上写锁。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 给mylock表上读锁，给book表上写锁
</span><span class="c1"></span><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="w"> </span><span class="k">READ</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">book</span><span class="o">`</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 查看当前表的状态
</span><span class="c1"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="n">OPEN</span><span class="w"> </span><span class="kp">TABLES</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">Database</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">Table</span><span class="w">                                                </span><span class="o">|</span><span class="w"> </span><span class="n">In_use</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Name_locked</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_analysis</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">book</span><span class="w">                                                 </span><span class="o">|</span><span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_analysis</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">mylock</span><span class="w">                                               </span><span class="o">|</span><span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3、释放表锁。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 释放给表添加的锁
</span><span class="c1"></span><span class="k">UNLOCK</span><span class="w"> </span><span class="kp">TABLES</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 查看当前表的状态
</span><span class="c1"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="n">OPEN</span><span class="w"> </span><span class="kp">TABLES</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">Database</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">Table</span><span class="w">                                                </span><span class="o">|</span><span class="w"> </span><span class="n">In_use</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Name_locked</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_analysis</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">book</span><span class="w">                                                 </span><span class="o">|</span><span class="w">      </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_analysis</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">mylock</span><span class="w">                                               </span><span class="o">|</span><span class="w">      </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+--------------------+------------------------------------------------------+--------+-------------+</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="163读锁案例">16.3.读锁案例</h2>
<blockquote>
<p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加读锁。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 为mylock表添加读锁
</span><span class="c1"></span><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="w"> </span><span class="k">READ</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1</span>

<span class="c1"># 问题1：SESSION1为mylock表加了读锁，可以读mylock表！</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>mylock<span class="sb">`</span><span class="p">;</span>
+----+----------+
<span class="p">|</span> id <span class="p">|</span> name     <span class="p">|</span>
+----+----------+
<span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> ZhangSan <span class="p">|</span>
<span class="p">|</span>  <span class="m">2</span> <span class="p">|</span> LiSi     <span class="p">|</span>
<span class="p">|</span>  <span class="m">3</span> <span class="p">|</span> WangWu   <span class="p">|</span>
<span class="p">|</span>  <span class="m">4</span> <span class="p">|</span> ZhaoLiu  <span class="p">|</span>
+----+----------+
<span class="m">4</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 问题2：SESSION1为mylock表加了读锁，不可以修改mylock表！</span>
mysql&gt; UPDATE <span class="sb">`</span>mylock<span class="sb">`</span> SET <span class="sb">`</span>name<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span> WHERE <span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
ERROR <span class="m">1099</span> <span class="o">(</span>HY000<span class="o">)</span>: Table <span class="s1">&#39;mylock&#39;</span> was locked with a READ lock and can<span class="s1">&#39;t be updated
</span><span class="s1">
</span><span class="s1"># 问题3：SESSION1为mylock表加了读锁，不可以读其他的表！
</span><span class="s1">mysql&gt; SELECT * FROM `book`;
</span><span class="s1">ERROR 1100 (HY000): Table &#39;</span>book<span class="s1">&#39; was not locked with LOCK TABLES
</span><span class="s1">
</span><span class="s1">
</span><span class="s1"># SESSION2
</span><span class="s1">
</span><span class="s1"># 问题1：SESSION1为mylock表加了读锁，SESSION2可以读mylock表！
</span><span class="s1">mysql&gt; SELECT * FROM `mylock`;
</span><span class="s1">+----+----------+
</span><span class="s1">| id | name     |
</span><span class="s1">+----+----------+
</span><span class="s1">|  1 | ZhangSan |
</span><span class="s1">|  2 | LiSi     |
</span><span class="s1">|  3 | WangWu   |
</span><span class="s1">|  4 | ZhaoLiu  |
</span><span class="s1">+----+----------+
</span><span class="s1">4 rows in set (0.00 sec)
</span><span class="s1">
</span><span class="s1"># 问题2：SESSION1为mylock表加了读锁，SESSION2修改mylock表会被阻塞，需要等待SESSION1释放mylock表！
</span><span class="s1">mysql&gt; UPDATE `mylock` SET `name` = &#39;</span>abc<span class="err">&#39;</span> WHERE <span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
^C^C -- query aborted
ERROR <span class="m">1317</span> <span class="o">(</span>70100<span class="o">)</span>: Query execution was interrupted

<span class="c1"># 问题3：SESSION1为mylock表加了读锁，SESSION2可以读其他表！</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>book<span class="sb">`</span><span class="p">;</span>
+--------+------+
<span class="p">|</span> bookid <span class="p">|</span> card <span class="p">|</span>
+--------+------+
<span class="p">|</span>      <span class="m">1</span> <span class="p">|</span>    <span class="m">1</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">7</span> <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">8</span> <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">9</span> <span class="p">|</span>    <span class="m">5</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">5</span> <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>
<span class="p">|</span>     <span class="m">17</span> <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>
<span class="p">|</span>     <span class="m">15</span> <span class="p">|</span>    <span class="m">8</span> <span class="p">|</span>
+--------+------+
<span class="m">24</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="164写锁案例">16.4.写锁案例</h2>
<blockquote>
<p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加写锁。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 为mylock表添加写锁
</span><span class="c1"></span><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">mylock</span><span class="o">`</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1</span>

<span class="c1"># 问题1：SESSION1为mylock表加了写锁，可以读mylock的表！</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>mylock<span class="sb">`</span><span class="p">;</span>
+----+----------+
<span class="p">|</span> id <span class="p">|</span> name     <span class="p">|</span>
+----+----------+
<span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> ZhangSan <span class="p">|</span>
<span class="p">|</span>  <span class="m">2</span> <span class="p">|</span> LiSi     <span class="p">|</span>
<span class="p">|</span>  <span class="m">3</span> <span class="p">|</span> WangWu   <span class="p">|</span>
<span class="p">|</span>  <span class="m">4</span> <span class="p">|</span> ZhaoLiu  <span class="p">|</span>
+----+----------+
<span class="m">4</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 问题2：SESSION1为mylock表加了写锁，可以修改mylock表!</span>
mysql&gt; UPDATE <span class="sb">`</span>mylock<span class="sb">`</span> SET <span class="sb">`</span>name<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span> WHERE <span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">0</span>

<span class="c1"># 问题3：SESSION1为mylock表加了写锁，不能读其他表!</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>book<span class="sb">`</span><span class="p">;</span>
ERROR <span class="m">1100</span> <span class="o">(</span>HY000<span class="o">)</span>: Table <span class="s1">&#39;book&#39;</span> was not locked with LOCK TABLES

<span class="c1"># SESSION2</span>

<span class="c1"># 问题1：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>mylock<span class="sb">`</span><span class="p">;</span>
^C^C -- query aborted
ERROR <span class="m">1317</span> <span class="o">(</span>70100<span class="o">)</span>: Query execution was interrupted

<span class="c1"># 问题2：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！</span>
mysql&gt; UPDATE <span class="sb">`</span>mylock<span class="sb">`</span> SET <span class="sb">`</span>name<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span> WHERE <span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
^C^C -- query aborted
ERROR <span class="m">1317</span> <span class="o">(</span>70100<span class="o">)</span>: Query execution was interrupted

<span class="c1"># 问题3：SESSION1为mylock表加了写锁，SESSION2可以读其他表！</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>book<span class="sb">`</span><span class="p">;</span>
+--------+------+
<span class="p">|</span> bookid <span class="p">|</span> card <span class="p">|</span>
+--------+------+
<span class="p">|</span>      <span class="m">1</span> <span class="p">|</span>    <span class="m">1</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">7</span> <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">8</span> <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">9</span> <span class="p">|</span>    <span class="m">5</span> <span class="p">|</span>
<span class="p">|</span>      <span class="m">5</span> <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>
<span class="p">|</span>     <span class="m">17</span> <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>
<span class="p">|</span>     <span class="m">15</span> <span class="p">|</span>    <span class="m">8</span> <span class="p">|</span>
+--------+------+
<span class="m">24</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="165案例结论">16.5.案例结论</h2>
<p><strong><code>MyISAM</code>引擎在执行查询语句<code>SELECT</code>之前，会自动给涉及到的所有表加读锁，在执行增删改之前，会自动给涉及的表加写锁。</strong></p>
<p>MySQL的表级锁有两种模式：</p>
<ul>
<li>
<p>表共享读锁（Table Read Lock）。</p>
</li>
<li>
<p>表独占写锁（Table Write Lock）。</p>
</li>
</ul>
<p>対<code>MyISAM</code>表进行操作，会有以下情况：</p>
<ul>
<li>対<code>MyISAM</code>表的读操作（加读锁），不会阻塞其他线程対同一表的读操作，但是会阻塞其他线程対同一表的写操作。只有当读锁释放之后，才会执行其他线程的写操作。</li>
<li>対<code>MyISAM</code>表的写操作（加写锁），会阻塞其他线程対同一表的读和写操作，只有当写锁释放之后，才会执行其他线程的读写操作。</li>
</ul>
<h2 id="166表锁分析">16.6.表锁分析</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; SHOW STATUS LIKE <span class="s1">&#39;table%&#39;</span><span class="p">;</span>
+----------------------------+-------+
<span class="p">|</span> Variable_name              <span class="p">|</span> Value <span class="p">|</span>
+----------------------------+-------+
<span class="p">|</span> Table_locks_immediate      <span class="p">|</span> <span class="m">173</span>   <span class="p">|</span>
<span class="p">|</span> Table_locks_waited         <span class="p">|</span> <span class="m">0</span>     <span class="p">|</span>
<span class="p">|</span> Table_open_cache_hits      <span class="p">|</span> <span class="m">5</span>     <span class="p">|</span>
<span class="p">|</span> Table_open_cache_misses    <span class="p">|</span> <span class="m">8</span>     <span class="p">|</span>
<span class="p">|</span> Table_open_cache_overflows <span class="p">|</span> <span class="m">0</span>     <span class="p">|</span>
+----------------------------+-------+
<span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以通过<code>Table_locks_immediate</code>和<code>Table_locks_waited</code>状态变量来分析系统上的表锁定。具体说明如下：</p>
<p><code>Table_locks_immediate</code>：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1。</p>
<p><code>Table_locks_waited</code>：出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在较严重的表级锁争用情况。</p>
<p><strong>此外，<code>MyISAM</code>的读写锁调度是写优先，这也是<code>MyISAM</code>不适合作为主表的引擎。因为写锁后，其他线程不能进行任何操作，大量的写操作会使查询很难得到锁，从而造成永远阻塞。</strong></p>
<h1 id="17行锁偏写">17.行锁(偏写)</h1>
<p><strong>行锁特点：</strong></p>
<ul>
<li>偏向<code>InnoDB</code>存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</li>
</ul>
<p><strong><code>InnoDB</code>存储引擎和<code>MyISAM</code>存储引擎最大不同有两点：一是支持事务，二是采用行锁。</strong></p>
<p>事务的ACID：</p>
<ul>
<li><code>Atomicity [ˌætəˈmɪsəti] </code>。</li>
<li><code>Consistency [kənˈsɪstənsi] </code>。</li>
<li><code>Isolation [ˌaɪsəˈleɪʃn]</code>。</li>
<li><code>Durability [ˌdjʊərəˈbɪlɪti] </code>。</li>
</ul>
<h2 id="171环境准备">17.1.环境准备</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="c1"># 建表语句
</span><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="w"> </span><span class="kt">INT</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="n">COMMENT</span><span class="o">=</span><span class="s1">&#39;测试行锁&#39;</span><span class="p">;</span><span class="w"> 
</span><span class="w">
</span><span class="w"></span><span class="c1"># 插入数据
</span><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b2&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;4000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;5000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;6000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;7000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;8000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">a</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">b</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;9000&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1"># 创建索引
</span><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_test_a</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_test_b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">`</span><span class="n">test_innodb_lock</span><span class="o">`</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="172行锁案例">17.2.行锁案例</h2>
<blockquote>
<p>1、开启手动提交</p>
</blockquote>
<p>打开<code>SESSION1</code>和<code>SESSION2</code>两个会话，都开启手动提交。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 开启MySQL数据库的手动提交</span>
mysql&gt; SET <span class="nv">autocommit</span><span class="o">=</span>0<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、读几知所写</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1 </span>

<span class="c1"># SESSION1対test_innodb_lock表做写操作，但是没有commit。</span>
<span class="c1"># 执行修改SQL之后，查询一下test_innodb_lock表，发现数据被修改了。</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;88&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">0</span>

mysql&gt; SELECT * FROM <span class="sb">`</span>test_innodb_lock<span class="sb">`</span><span class="p">;</span>
+------+------+
<span class="p">|</span> a    <span class="p">|</span> b    <span class="p">|</span>
+------+------+
<span class="p">|</span>    <span class="m">1</span> <span class="p">|</span> <span class="m">88</span>   <span class="p">|</span>
<span class="p">|</span>    <span class="m">2</span> <span class="p">|</span> <span class="m">3</span>    <span class="p">|</span>
<span class="p">|</span>    <span class="m">3</span> <span class="p">|</span> <span class="m">4000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">4</span> <span class="p">|</span> <span class="m">5000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">5</span> <span class="p">|</span> <span class="m">6000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">6</span> <span class="p">|</span> <span class="m">7000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">7</span> <span class="p">|</span> <span class="m">8000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">8</span> <span class="p">|</span> <span class="m">9000</span> <span class="p">|</span>
+------+------+
<span class="m">8</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># SESSION2 </span>

<span class="c1"># SESSION2这时候来查询test_innodb_lock表。</span>
<span class="c1"># 发现SESSION2是读不到SESSION1未提交的数据的。</span>
mysql&gt; SELECT * FROM <span class="sb">`</span>test_innodb_lock<span class="sb">`</span><span class="p">;</span>
+------+------+
<span class="p">|</span> a    <span class="p">|</span> b    <span class="p">|</span>
+------+------+
<span class="p">|</span>    <span class="m">1</span> <span class="p">|</span> b2   <span class="p">|</span>
<span class="p">|</span>    <span class="m">2</span> <span class="p">|</span> <span class="m">3</span>    <span class="p">|</span>
<span class="p">|</span>    <span class="m">3</span> <span class="p">|</span> <span class="m">4000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">4</span> <span class="p">|</span> <span class="m">5000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">5</span> <span class="p">|</span> <span class="m">6000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">6</span> <span class="p">|</span> <span class="m">7000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">7</span> <span class="p">|</span> <span class="m">8000</span> <span class="p">|</span>
<span class="p">|</span>    <span class="m">8</span> <span class="p">|</span> <span class="m">9000</span> <span class="p">|</span>
+------+------+
<span class="m">8</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 se
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3、行锁两个SESSION同时対一条记录进行写操作</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1 対test_innodb_lock表的`a`=1这一行进行写操作，但是没有commit</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;99&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">0</span>

<span class="c1"># SESSION2 也对test_innodb_lock表的`a`=1这一行进行写操作，但是发现阻塞了！！！</span>
<span class="c1"># 等SESSION1执行commit语句之后，SESSION2的SQL就会执行了</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;asdasd&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
ERROR <span class="m">1205</span> <span class="o">(</span>HY000<span class="o">)</span>: Lock <span class="nb">wait</span> timeout exceeded<span class="p">;</span> try restarting transaction
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>4、行锁两个SESSION同时对不同记录进行写操作</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1 対test_innodb_lock表的`a`=6这一行进行写操作，但是没有commit</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;8976&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 6<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">0</span>

<span class="c1"># SESSION2 対test_innodb_lock表的`a`=4这一行进行写操作，没有阻塞！！！</span>
<span class="c1"># SESSION1和SESSION2同时对不同的行进行写操作互不影响</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;Ringo&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 4<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="173索引失效行锁变表锁">17.3.索引失效行锁变表锁</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># SESSION1 执行SQL语句，没有执行commit。</span>
<span class="c1"># 由于`b`字段是字符串，但是没有加单引号导致索引失效</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> <span class="m">888</span> WHERE <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> 8000<span class="p">;</span>
Query OK, <span class="m">1</span> row affected, <span class="m">1</span> warning <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: <span class="m">1</span>  Changed: <span class="m">1</span>  Warnings: <span class="m">1</span>

<span class="c1"># SESSION2 和SESSION1操作的并不是同一行，但是也被阻塞了？？？</span>
<span class="c1"># 由于SESSION1执行的SQL索引失效，导致行锁升级为表锁。</span>
mysql&gt; UPDATE <span class="sb">`</span>test_innodb_lock<span class="sb">`</span> SET <span class="sb">`</span>b<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;1314&#39;</span> WHERE <span class="sb">`</span>a<span class="sb">`</span> <span class="o">=</span> 1<span class="p">;</span>
ERROR <span class="m">1205</span> <span class="o">(</span>HY000<span class="o">)</span>: Lock <span class="nb">wait</span> timeout exceeded<span class="p">;</span> try restarting transaction
</code></pre></td></tr></table>
</div>
</div><h2 id="174间隙锁的危害">17.4.间隙锁的危害</h2>
<blockquote>
<p>什么是间隙锁？</p>
</blockquote>
<p>当我们用范围条件而不是相等条件检索数据，并请求共享或者排他锁时，<code>InnoDB</code>会给符合条件的已有数据记录的索引项加锁，对于键值在条件范文内但并不存在的记录，叫做&quot;间隙(GAP)&quot;。</p>
<p><code>InnoDB</code>也会对这个&quot;间隙&quot;加锁，这种锁的机制就是所谓的&quot;间隙锁&quot;。</p>
<blockquote>
<p>间隙锁的危害</p>
</blockquote>
<p>因为<code>Query</code>执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值不存在。</p>
<p>间隙锁有一个比较致命的缺点，就是**当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。**在某些场景下这可能会対性能造成很大的危害。</p>
<h2 id="175如何锁定一行">17.5.如何锁定一行</h2>
<p><img src="https://img-blog.csdnimg.cn/2020080616050355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="锁定一行"></p>
<p><code>SELECT .....FOR UPDATE</code>在锁定某一行后，其他写操作会被阻塞，直到锁定的行被<code>COMMIT</code>。</p>
<p>mysql InnoDB引擎默认的修改数据语句，update,delete,insert都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型，如果加排他锁可以使用select &hellip;for update语句，加共享锁可以使用select &hellip; lock in share mode语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update和lock in share mode锁的方式查询数据，但可以直接通过select &hellip;from&hellip;查询数据，因为普通查询没有任何锁机制。</p>
<p><img src="https://img-blog.csdnimg.cn/20210421122919994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="image-20210421122752768"></p>
<h2 id="176案例结论">17.6.案例结论</h2>
<p><code>InnoDB</code>存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于<code>MyISAM</code>的表级锁定的。当系统并发量较高的时候，<code>InnoDB</code>的整体性能和<code>MyISAM</code>相比就会有比较明显的优势了。</p>
<p>但是，<code>InnoDB</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>InnoDB</code>的整体性能表现不仅不能比<code>MyISAM</code>高，甚至可能会更差。</p>
<h2 id="177行锁分析">17.7.行锁分析</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mysql&gt; SHOW STATUS LIKE <span class="s1">&#39;innodb_row_lock%&#39;</span><span class="p">;</span>
+-------------------------------+--------+
<span class="p">|</span> Variable_name                 <span class="p">|</span> Value  <span class="p">|</span>
+-------------------------------+--------+
<span class="p">|</span> Innodb_row_lock_current_waits <span class="p">|</span> <span class="m">0</span>      <span class="p">|</span>
<span class="p">|</span> Innodb_row_lock_time          <span class="p">|</span> <span class="m">124150</span> <span class="p">|</span>
<span class="p">|</span> Innodb_row_lock_time_avg      <span class="p">|</span> <span class="m">31037</span>  <span class="p">|</span>
<span class="p">|</span> Innodb_row_lock_time_max      <span class="p">|</span> <span class="m">51004</span>  <span class="p">|</span>
<span class="p">|</span> Innodb_row_lock_waits         <span class="p">|</span> <span class="m">4</span>      <span class="p">|</span>
+-------------------------------+--------+
<span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>対各个状态量的说明如下：</p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>：当前正在等待锁定的数量。</li>
<li><code>Innodb_row_lock_time</code>：从系统启动到现在锁定总时间长度（重要）。</li>
<li><code>Innodb_row_lock_time_avg</code>：每次等待所花的平均时间（重要）。</li>
<li><code>Innodb_row_lock_time_max</code>：从系统启动到现在等待最长的一次所花的时间。</li>
<li><code>Innodb_row_lock_waits</code>：系统启动后到现在总共等待的次数（重要）。</li>
</ul>
<p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化策略。</p>
<h1 id="18主从复制">18.主从复制</h1>
<h2 id="181复制基本原理">18.1.复制基本原理</h2>
<p><img src="https://img-blog.csdnimg.cn/20200806170415401.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="主从复制"></p>
<p>MySQL复制过程分为三步：</p>
<ul>
<li>Master将改变记录到二进制日志(Binary Log)。这些记录过程叫做二进制日志事件，<code>Binary Log Events</code>；</li>
<li>Slave将Master的<code>Binary Log Events</code>拷贝到它的中继日志(Replay  Log);</li>
<li>Slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步且串行化的。</li>
</ul>
<h2 id="182复制基本原则">18.2.复制基本原则</h2>
<ul>
<li>每个Slave只有一个Master。</li>
<li>每个Slave只能有一个唯一的服务器ID。</li>
<li>每个Master可以有多个Salve。</li>
</ul>
<h2 id="183一主一从配置">18.3.一主一从配置</h2>
<blockquote>
<p>1、基本要求：Master和Slave的MySQL服务器版本一致且后台以服务运行。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建mysql-slave1实例</span>
docker run -p 3307:3306 --name mysql-slave1 <span class="se">\
</span><span class="se"></span>-v /root/mysql-slave1/log:/var/log/mysql <span class="se">\
</span><span class="se"></span>-v /root/mysql-slave1/data:/var/lib/mysql <span class="se">\
</span><span class="se"></span>-v /root/mysql-slave1/conf:/etc/mysql <span class="se">\
</span><span class="se"></span>-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="m">333</span> <span class="se">\
</span><span class="se"></span>-d mysql:5.7
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2、主从配置都是配在[mysqld]节点下，都是小写</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Master配置</span>
<span class="o">[</span>mysqld<span class="o">]</span>
server-id<span class="o">=</span><span class="m">1</span> <span class="c1"># 必须</span>
log-bin<span class="o">=</span>/var/lib/mysql/mysql-bin <span class="c1"># 必须</span>
read-only<span class="o">=</span><span class="m">0</span>
binlog-ignore-db<span class="o">=</span>mysql
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Slave配置</span>
<span class="o">[</span>mysqld<span class="o">]</span>
server-id<span class="o">=</span><span class="m">2</span> <span class="c1"># 必须</span>
log-bin<span class="o">=</span>/var/lib/mysql/mysql-bin
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3、Master配置</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、GRANT REPLICATION SLAVE ON *.* TO &#39;username&#39;@&#39;从机IP地址&#39; IDENTIFIED BY &#39;password&#39;;</span>
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class="s1">&#39;zhangsan&#39;</span>@<span class="s1">&#39;172.18.0.3&#39;</span> IDENTIFIED BY <span class="s1">&#39;123456&#39;</span><span class="p">;</span>
Query OK, <span class="m">0</span> rows affected, <span class="m">1</span> warning <span class="o">(</span>0.01 sec<span class="o">)</span>

<span class="c1"># 2、刷新命令</span>
mysql&gt; FLUSH PRIVILEGES<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 3、记录下File和Position</span>
<span class="c1"># 每次配从机的时候都要SHOW MASTER STATUS;查看最新的File和Position</span>
mysql&gt; SHOW MASTER STATUS<span class="p">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="p">|</span> File             <span class="p">|</span> Position <span class="p">|</span> Binlog_Do_DB <span class="p">|</span> Binlog_Ignore_DB <span class="p">|</span> Executed_Gtid_Set <span class="p">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="p">|</span> mysql-bin.000001 <span class="p">|</span>      <span class="m">602</span> <span class="p">|</span>              <span class="p">|</span> mysql            <span class="p">|</span>                   <span class="p">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>4、Slave从机配置</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">CHANGE MASTER TO <span class="nv">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;172.18.0.4&#39;</span>,
<span class="nv">MASTER_USER</span><span class="o">=</span><span class="s1">&#39;zhangsan&#39;</span>,
<span class="nv">MASTER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>,
<span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;mysql-bin.File的编号&#39;</span>,
<span class="nv">MASTER_LOG_POS</span><span class="o">=</span>Position的最新值<span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、使用用户名密码登录进Master</span>
mysql&gt; CHANGE MASTER TO <span class="nv">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;172.18.0.4&#39;</span>,
    -&gt; <span class="nv">MASTER_USER</span><span class="o">=</span><span class="s1">&#39;zhangsan&#39;</span>,
    -&gt; <span class="nv">MASTER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>,
    -&gt; <span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;mysql-bin.000001&#39;</span>,
    -&gt; <span class="nv">MASTER_LOG_POS</span><span class="o">=</span>602<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected, <span class="m">2</span> warnings <span class="o">(</span>0.02 sec<span class="o">)</span>

<span class="c1"># 2、开启Slave从机的复制</span>
mysql&gt; START SLAVE<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 3、查看Slave状态</span>
<span class="c1"># Slave_IO_Running 和 Slave_SQL_Running 必须同时为Yes 说明主从复制配置成功！</span>
mysql&gt; SHOW SLAVE STATUS<span class="se">\G</span>
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span class="k">for</span> master to send event <span class="c1"># Slave待命状态</span>
                  Master_Host: 172.18.0.4
                  Master_User: zhangsan
                  Master_Port: <span class="m">3306</span>
                Connect_Retry: <span class="m">60</span>
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: <span class="m">602</span>
               Relay_Log_File: b030ad25d5fe-relay-bin.000002
                Relay_Log_Pos: <span class="m">320</span>
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes  
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: <span class="m">0</span>
                   Last_Error: 
                 Skip_Counter: <span class="m">0</span>
          Exec_Master_Log_Pos: <span class="m">602</span>
              Relay_Log_Space: <span class="m">534</span>
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: <span class="m">0</span>
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: <span class="m">0</span>
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: <span class="m">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span class="m">0</span>
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: <span class="m">1</span>
                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: <span class="m">0</span>
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has <span class="nb">read</span> all relay log<span class="p">;</span> waiting <span class="k">for</span> more updates
           Master_Retry_Count: <span class="m">86400</span>
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: <span class="m">0</span>
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>5、测试主从复制</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Master创建数据库</span>
mysql&gt; create database test_replication<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.01 sec<span class="o">)</span>

<span class="c1"># Slave查询数据库</span>
mysql&gt; show databases<span class="p">;</span>
+--------------------+
<span class="p">|</span> Database           <span class="p">|</span>
+--------------------+
<span class="p">|</span> information_schema <span class="p">|</span>
<span class="p">|</span> mysql              <span class="p">|</span>
<span class="p">|</span> performance_schema <span class="p">|</span>
<span class="p">|</span> sys                <span class="p">|</span>
<span class="p">|</span> test_replication   <span class="p">|</span>
+--------------------+
<span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>6、停止主从复制功能</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1、停止Slave</span>
mysql&gt; STOP SLAVE<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>

<span class="c1"># 2、重新配置主从</span>
<span class="c1"># MASTER_LOG_FILE 和 MASTER_LOG_POS一定要根据最新的数据来配</span>
mysql&gt; CHANGE MASTER TO <span class="nv">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;172.18.0.4&#39;</span>,
    -&gt; <span class="nv">MASTER_USER</span><span class="o">=</span><span class="s1">&#39;zhangsan&#39;</span>,
    -&gt; <span class="nv">MASTER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>,
    -&gt; <span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;mysql-bin.000001&#39;</span>,
    -&gt; <span class="nv">MASTER_LOG_POS</span><span class="o">=</span>797<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected, <span class="m">2</span> warnings <span class="o">(</span>0.01 sec<span class="o">)</span>

mysql&gt; START SLAVE<span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; SHOW SLAVE STATUS<span class="se">\G</span>
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span class="k">for</span> master to send event
                  Master_Host: 172.18.0.4
                  Master_User: zhangsan
                  Master_Port: <span class="m">3306</span>
                Connect_Retry: <span class="m">60</span>
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: <span class="m">797</span>
               Relay_Log_File: b030ad25d5fe-relay-bin.000002
                Relay_Log_Pos: <span class="m">320</span>
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: <span class="m">0</span>
                   Last_Error: 
                 Skip_Counter: <span class="m">0</span>
          Exec_Master_Log_Pos: <span class="m">797</span>
              Relay_Log_Space: <span class="m">534</span>
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: <span class="m">0</span>
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: <span class="m">0</span>
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: <span class="m">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span class="m">0</span>
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: <span class="m">1</span>
                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: <span class="m">0</span>
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has <span class="nb">read</span> all relay log<span class="p">;</span> waiting <span class="k">for</span> more updates
           Master_Retry_Count: <span class="m">86400</span>
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: <span class="m">0</span>
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">bomir</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-11-12
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bomir.top/tags/mysql/">mysql</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/message-queue-record/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">消息队列记录</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/redis-interview-1/">
            <span class="next-text nav-default">redis面试连环炮I</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Shaper-fox/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:jinchunw@385@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Bicomir" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bomir.top/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        bomir
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
