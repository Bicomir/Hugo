<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>改善C#代码的157个建议（2）- 集合与LINQ - Wallis</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="bomir" />
  <meta name="description" content="集合和LINQ 建议16： 元素数量在可变的情况下不应该使用数组 ​ 在C#中，数组一旦被创建，长度就不能改变。如果我们需要一个动态且可变长度的集合" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.85.0" />


<link rel="canonical" href="https://bomir.top/post/collection_and_linq/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="改善C#代码的157个建议（2）- 集合与LINQ" />
<meta property="og:description" content="集合和LINQ 建议16： 元素数量在可变的情况下不应该使用数组 ​ 在C#中，数组一旦被创建，长度就不能改变。如果我们需要一个动态且可变长度的集合" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bomir.top/post/collection_and_linq/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-11-20T22:19:05+00:00" />
<meta property="article:modified_time" content="2019-11-20T22:19:05+00:00" />

<meta itemprop="name" content="改善C#代码的157个建议（2）- 集合与LINQ">
<meta itemprop="description" content="集合和LINQ 建议16： 元素数量在可变的情况下不应该使用数组 ​ 在C#中，数组一旦被创建，长度就不能改变。如果我们需要一个动态且可变长度的集合"><meta itemprop="datePublished" content="2019-11-20T22:19:05+00:00" />
<meta itemprop="dateModified" content="2019-11-20T22:19:05+00:00" />
<meta itemprop="wordCount" content="14898">
<meta itemprop="keywords" content="CSharp," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="改善C#代码的157个建议（2）- 集合与LINQ"/>
<meta name="twitter:description" content="集合和LINQ 建议16： 元素数量在可变的情况下不应该使用数组 ​ 在C#中，数组一旦被创建，长度就不能改变。如果我们需要一个动态且可变长度的集合"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">秤流沙</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      秤流沙
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.top/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">改善C#代码的157个建议（2）- 集合与LINQ</h1>
      
      <div class="post-meta">
        <time datetime="2019-11-20" class="post-time">
          2019-11-20
        </time>
        <div class="post-category">
            <a href="https://bomir.top/categories/csharp/"> CSharp </a>
            
          </div>
        <span class="more-meta"> 约 14898 字 </span>
          <span class="more-meta"> 预计阅读 30 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#建议16-元素数量在可变的情况下不应该使用数组">建议16： 元素数量在可变的情况下不应该使用数组</a></li>
        <li><a href="#建议17多数情况下使用foreach进行循环遍历">建议17：多数情况下使用foreach进行循环遍历</a></li>
        <li><a href="#建议18foreach不能代替for">建议18：<code>foreach</code>不能代替for</a></li>
        <li><a href="#建议19使用更有效的对象和集合初始化">建议19：使用更有效的对象和集合初始化</a></li>
        <li><a href="#建议20使用泛型集合代替非泛型集合">建议20：使用泛型集合代替非泛型集合</a></li>
        <li><a href="#建议21选择正确的集合">建议21：选择正确的集合</a></li>
        <li><a href="#建议22确保集合的线程安全">建议22：确保集合的线程安全</a></li>
        <li><a href="#建议23避免将list作为自定义集合类的基类">建议23：避免将List作为自定义集合类的基类</a></li>
        <li><a href="#建议24迭代器应该是只读的">建议24：迭代器应该是只读的</a></li>
        <li><a href="#建议25谨慎集合属性的可写操作">建议25：谨慎集合属性的可写操作</a></li>
        <li><a href="#建议26使用匿名类型存储linq查询结果">建议26：使用匿名类型存储LINQ查询结果</a></li>
        <li><a href="#建议27在查询中使用lambda表达式">建议27：在查询中使用Lambda表达式</a></li>
        <li><a href="#建议28理解延迟求值和主动求值之间的区别">建议28：理解延迟求值和主动求值之间的区别</a></li>
        <li><a href="#建议29区别linq查询中的ienumerable和iqueryable">建议29：区别LINQ查询中的IEnumerable和IQueryable</a></li>
        <li><a href="#建议30使用linq取代集合中的比较器和迭代器">建议30：使用LINQ取代集合中的比较器和迭代器</a></li>
        <li><a href="#建议31在linq查询中避免不必要的迭代">建议31：在LINQ查询中避免不必要的迭代</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="集合和linq">集合和LINQ</h1>
<h3 id="建议16-元素数量在可变的情况下不应该使用数组">建议16： 元素数量在可变的情况下不应该使用数组</h3>
<p>​		在C#中，数组一旦被创建，长度就不能改变。如果我们需要一个动态且可变长度的集合，就应该使用ArrayList或List<!-- raw HTML omitted -->来创建。 而数组本身，尤其是一维数组，在遇到要求高效率的算法时，则会专门被优化以提升其效率。一维数组也成为向量，其性能是最佳的，在IL中使用了专门的指令来 处理它们（如<code>newarr、ldelem、ldelema、ldelen和stelem</code>）。</p>
<p>​		从内存的使用角度来讲，数组在创建时被分配了一段固定长度的内存。如果数组的元素是值类型，则每个元素的长度等于相应的值类型的长度；如果数组的元素是引用类型，则每个元素的长度为该引用类型的<code>IntPtr.Size</code>（<code>IntPtr：It's a class that wraps a pointer that is used when calling Windows API functions. The underlying pointer may be 32 bit or 64 bit, depending on the platform.</code>）。数组的存储结构一旦被分配，就不能再变化。而ArrayList是链表结构，可以动态的增减内存空间，如果ArrayList存储的是值类型，则会为每个元素增加12字节的空间，其中4个字节拥有对象引用，8字节是元素装箱时引入的对象头。List<!-- raw HTML omitted -->是ArrayList的泛型实现，它省去了装箱和拆箱带来的开销。</p>
<p>​	<strong>注意：</strong></p>
<p>​	由于数组本身在内存上的特点，因此在使用数组的过程中还应该注意大对象的问题。所谓“大对象”，是指那些占内存超过85000字节的对象，它们被分配在大对象堆里。大对象的分配和回收和小对象都不太一样，尤其是回收，大对象在回收过程中会带来效率很低的问题。所以，不能对数组指定过大的长度，这会让数组成为一个大对象。</p>
<p>如果一定要动态改变数组的长度，一种做法是将数组转换为ArrayList或List<!-- raw HTML omitted -->,  如下面的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice16</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span><span class="p">[]</span> <span class="n">iArr</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">};</span>
            <span class="n">ArrayList</span> <span class="n">arrayList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">(</span><span class="n">iArr</span><span class="p">);</span>

            <span class="n">arrayList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">listInt</span> <span class="p">=</span> <span class="n">iArr</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
            <span class="n">listInt</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">arrayList</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">item</span> <span class="p">+</span> <span class="s">&#34; &#34;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

            <span class="n">listInt</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">x</span> <span class="p">+</span> <span class="s">&#34; &#34;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		还有一种办法是数组的复制功能， 数组继承自<code>System.Array</code>,  抽象类<code>System.Array</code>提供了一些有用的实现方法。其中就包括Copy方法，它负责将一个数组的内容复制到另外一个数组中。无论哪种方法，改变数组长度就相当于重新创建了一个数组对象。</p>
<p>​		为了让数组看上去本身就具有动态改变长度的功能，可以创建一个名为Resize的扩展方法，代码如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice16</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span><span class="p">[]</span> <span class="n">iArr</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">};</span>
            <span class="n">iArr</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">[])</span><span class="n">iArr</span><span class="p">.</span><span class="n">Resize</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iArr</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">iArr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ClassForExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">Array</span> <span class="n">Resize</span><span class="p">(</span><span class="k">this</span> <span class="n">Array</span> <span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newSize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Type</span> <span class="n">t</span> <span class="p">=</span> <span class="n">array</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetElementType</span><span class="p">();</span>
            <span class="n">Array</span> <span class="n">newArray</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">newSize</span><span class="p">);</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">newArray</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Math</span><span class="p">.</span><span class="n">Min</span><span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">newSize</span><span class="p">));</span>
            <span class="k">return</span> <span class="n">newArray</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面对改变数组长度和改变<code>Lisit&lt;T&gt;</code>长度的耗时做一个比较，以便强调本建议的主题：在元素数量可变的情况下不应该使用数组:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice16</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ResizeArray</span><span class="p">();</span>
            <span class="n">ResizeList</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">int</span><span class="p">[]</span> <span class="n">iArr</span> <span class="p">=</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span> <span class="p">};</span>
            <span class="n">Stopwatch</span> <span class="n">watch</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Stopwatch</span><span class="p">();</span>
            <span class="n">watch</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="n">iArr</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">[])</span><span class="n">iArr</span><span class="p">.</span><span class="n">Resize</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
            <span class="n">watch</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;ResizeArray: &#34;</span> <span class="p">+</span> <span class="n">watch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="n">ResizeList</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">iArr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span> <span class="p">});</span>
            <span class="n">Stopwatch</span> <span class="n">watch</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Stopwatch</span><span class="p">();</span>
            <span class="n">watch</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="n">iArr</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
            <span class="n">iArr</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
            <span class="n">iArr</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
            <span class="n">watch</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;ResizeList: &#34;</span> <span class="p">+</span> <span class="n">watch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ClassForExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">Array</span> <span class="n">Resize</span><span class="p">(</span><span class="k">this</span> <span class="n">Array</span> <span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newSize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Type</span> <span class="n">t</span> <span class="p">=</span> <span class="n">array</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetElementType</span><span class="p">();</span>
            <span class="n">Array</span> <span class="n">newArray</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">newSize</span><span class="p">);</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">newArray</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">Math</span><span class="p">.</span><span class="n">Min</span><span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">newSize</span><span class="p">));</span>
            <span class="k">return</span> <span class="n">newArray</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出为：</p>
<p><img src="https://bomir.top/pics/CSharpAdvice/image-20211202195104375.png" alt="image-20211202195104375"></p>
<p>当然，严格意义上讲，List<!-- raw HTML omitted -->不存在改变长度的说法，本建议只是为了比较，将<code>iArr</code>的长度变为10，同时还进行了赋值。即便这样，我们可以看到，在时间效率上<code>ResizeList</code>比<code>ResizeArray</code>要高100倍以上。</p>
<h3 id="建议17多数情况下使用foreach进行循环遍历">建议17：多数情况下使用foreach进行循环遍历</h3>
<p>​		这个主要是针对集合遍历的情况， 我们设想一下一般是如何对集合进行遍历的。假设存在一个数组，其遍历模式可以采用依据索引来进行遍历的方法；又假设存在一个哈希表，它的遍历模式可能是按照键值来进行遍历。无论是哪个集合，如果它们的遍历没有一个公共的接口，那么客户端在进行遍历的时候，相当于是对具体类型进行了一个编码，这样一来当需求发生变更时， 必须修改我们的代码。而且，由于客户端代码过多的关注集合内部的实现，代码的可移植性就会变得很差，这样直接违背了面向对象的开闭原则，于是迭代器模式就诞生了。</p>
<p>​		现在，我们不用管FCL是如何实现该模式的，先自己来实现一个迭代器模式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">namespace</span> <span class="nn">Advice17</span>
<span class="p">{</span>
    <span class="c1">// 要求所有迭代器全部实现该接口
</span><span class="c1"></span>    <span class="k">interface</span> <span class="n">IMyEnumerator</span>
    <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">MoveNext</span><span class="p">();</span>

        <span class="kt">object</span> <span class="n">Current</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 要求所有的集合实现该接口
</span><span class="c1"></span>    <span class="c1">// 这样一来， 客户端就可以针对该接口编码， 而无需关注具体的实现
</span><span class="c1"></span>    <span class="k">interface</span> <span class="n">IMyEnumerable</span>
    <span class="p">{</span>
        <span class="n">IMyEnumerator</span> <span class="n">GetEnumerator</span><span class="p">();</span>

        <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">MyList</span> <span class="p">:</span> <span class="n">IMyEnumerable</span>
    <span class="p">{</span>
        <span class="kt">object</span><span class="p">[]</span> <span class="n">items</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">10</span><span class="p">];</span>
        <span class="n">IMyEnumerator</span> <span class="n">myEnumerator</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">object</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">i</span><span class="p">]</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
            <span class="k">set</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">=&gt;</span> <span class="n">items</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">IMyEnumerator</span> <span class="n">GetEnumerator</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">myEnumerator</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">myEnumerator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyEnumerator</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">myEnumerator</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">MyEnumerator</span> <span class="p">:</span> <span class="n">IMyEnumerator</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">MyList</span> <span class="n">myList</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">MyEnumerator</span><span class="p">(</span><span class="n">MyList</span> <span class="n">myList</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">myList</span> <span class="p">=</span> <span class="n">myList</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">object</span> <span class="n">Current</span> <span class="p">=&gt;</span> <span class="n">myList</span><span class="p">[</span><span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="n">MoveNext</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">+</span> <span class="m">1</span> <span class="p">&gt;</span> <span class="n">myList</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">index</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">index</span><span class="p">++;</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Main函数去调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">namespace</span> <span class="nn">Advice17</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 使用接口IMyEnumerable代替MyList
</span><span class="c1"></span>            <span class="n">IMyEnumerable</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyList</span><span class="p">();</span>

            <span class="c1">// 得到迭代器， 在循环中针对迭代器编码， 而不是集合MyList
</span><span class="c1"></span>            <span class="n">IMyEnumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="kt">object</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
                <span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">object</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		<code>MyList</code>模拟了一个集合类，它继承了接口<code>IMyEnumerable</code>，这样，在客户端调用的时候，我们就可以直接调用<code>IMyEnumerable</code>来声明变量，如代码中的以下语句：</p>
<p><code>IMyEnumerable list = new MyList();</code></p>
<p>​		如果以后我们新增了其他的集合类，那么针对list的编码即使不做修改也能运行良好。在<code>IMyEnumerable</code>中声明了<code>GetEnumerator</code>方法返回一个继承了<code>IMyEnumerator</code>的对象。在<code>MyList</code>的内部，默认返回<code>MyEnumerator</code>，<code>MyEnumerator</code>就是迭代器的一个实现，如果对于迭代的需求有变化，可以重新开发一个迭代器，然后在客户端迭代的时候使用该迭代器。</p>
<p>​		在客户端的代码中，我们在迭代的过程中分别演示了for循环和while循环，到那时因为使用了迭代器的缘故，两个循环都没有针对<code>MyList</code>编码，而是实现了对迭代器的编码。</p>
<p>​		理解了自己实现的迭代器模式，相当于理解了FCL中提供的对应模式。以上代码中，在接口和类型中都加入了“My”字样，其实，FCL中有与之相对应的接口和类型，只不过为了演示需要，增加了其中部分内容，但是大致思路是一样的。使用FCL中相应类型进行客户端代码编写，大致应该下面这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">ICollection</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;();</span>
<span class="n">IEnumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="kt">object</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
    <span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">object</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>但是目前看来， 无论是for循环还是while循环， 都有些啰嗦， 于是， foreach便出现了；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#">  <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">current</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
  <span class="p">{</span>
 	 <span class="c1">// ignore  object current = enumerator.Current;
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里使用<code>ildasm</code>(<code>il</code>叫中间语言， <code>dasm</code>叫反编译)来查看一下<code>exe</code>文件，</p>
<p><img src="https://bomir.top/pics/CSharpAdvice/image-20211203113548389.png" alt="image-20211203113548389"></p>
<p>可以看到，采用foreach最大限度地简化了代码。它用于遍历一个继承了<code>IEnumerable</code>或<code>IEnumerable&lt;T&gt;</code>接口的集合元素。借助IL代码，我们查看使用foreach到底发生了什么事情：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">.method private hidebysig static void  Main(string[] args) cil managed
{
  .entrypoint
  // 代码大小       65 (0x41)
  .maxstack  1
  .locals init ([0] class Advice17.IMyEnumerable list,
           [1] class Advice17.IMyEnumerator enumerator,
           [2] class Advice17.IMyEnumerator V_2,
           [3] object current,
           [4] class [mscorlib]System.IDisposable V_4)
  IL_0000:  nop
  IL_0001:  newobj     instance void Advice17.MyList::.ctor()
  IL_0006:  stloc.0
  IL_0007:  ldloc.0
  IL_0008:  callvirt   instance class Advice17.IMyEnumerator Advice17.IMyEnumerable::GetEnumerator()
  IL_000d:  stloc.1
  IL_000e:  nop
  IL_000f:  ldloc.0
  IL_0010:  callvirt   instance class Advice17.IMyEnumerator Advice17.IMyEnumerable::GetEnumerator()
  IL_0015:  stloc.2
  .try
  {
    IL_0016:  br.s       IL_0021
    IL_0018:  ldloc.2
    IL_0019:  callvirt   instance object Advice17.IMyEnumerator::get_Current()
    IL_001e:  stloc.3
    IL_001f:  nop
    IL_0020:  nop
    IL_0021:  ldloc.2
    IL_0022:  callvirt   instance bool Advice17.IMyEnumerator::MoveNext()
    IL_0027:  brtrue.s   IL_0018
    IL_0029:  leave.s    IL_0040
  }  // end .try
  finally
  {
    IL_002b:  ldloc.2
    IL_002c:  isinst     [mscorlib]System.IDisposable
    IL_0031:  stloc.s    V_4
    IL_0033:  ldloc.s    V_4
    IL_0035:  brfalse.s  IL_003f
    IL_0037:  ldloc.s    V_4
    IL_0039:  callvirt   instance void [mscorlib]System.IDisposable::Dispose()
    IL_003e:  nop
    IL_003f:  endfinally
  }  // end handler
  IL_0040:  ret
} // end of method Program::Main
</code></pre></td></tr></table>
</div>
</div><p>查看IL代码就可以看出，运行时还是会调用<code>get_Current()</code>和<code>MoveNext()</code>方法。</p>
<p>在调用完<code>MoveNext()</code>方法后，如果结果是true，跳转到循环开始处。实际上foreach循环和while循环是一样的：</p>
<p>我们发现，foreach循环除了可以提供简化的语法外，还有另外两个优势：</p>
<ul>
<li>自动将代码置入try finally语句块；</li>
<li>若类型实现了<code>IDisposable</code>接口，它会在循环结束后自动调用Dispose方法。</li>
</ul>
<h3 id="建议18foreach不能代替for">建议18：<code>foreach</code>不能代替for</h3>
<p>前面提到foreach有两个优点：语法简单，默认调用Dispose方法，因此强烈建议在在实际的代码编写中更多的使用foreach。但是，该建议也有不适合的场景。</p>
<p>foreach存在一个问题：它不支持循环时对集合进行增删操作。比如，运行下面代码会抛出异常InvalidOperationException：</p>
<blockquote>
<p>``at System.ThrowHelper.ThrowInvalidOperationException(ExceptionResource resource)<code></code>at System.Collections.Generic.List1.Enumerator.MoveNextRare()
at System.Collections.Generic.List1.Enumerator.MoveNext()<code>at Advice18.Program.Main(String[] args) in F:\Demos\CsharpAdvice\Advice18\Program.cs:line 11</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span> <span class="p">};</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">list</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>取而代之的是for循环：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">list</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>foreach循环使用了迭代器进行集合的遍历，它在FCL提供的迭代替内部维护了一个对集合版本的控制。</p>
<p><strong>什么是集合版本？</strong></p>
<p>​	简单来说，实际上是一个整型变量，任何对集合的增删操作都会使版本号加1. foreach会调用MoveNext方法来遍历元素，在MoveNext方法内部会进行版本号的检测，一旦检测到版本号有变动，就会抛出InvalidOperationException异常。</p>
<p>​	如果使用for就不会带来这样的问题，for直接使用索引器，它不对集合版本号进行判断，所以不会存在以为集合的变动而带来的异常（当然，<strong>超出索引长度这种异常情况</strong>除外）。</p>
<p>​	由于for循环和foreach循环实现上有所不同（前者索引器，后者迭代器），因此关于两者性能上的争议从来没有停止过。但是，即使有争议，双方都承认两者在时间和内存上有损耗，尤其是针对泛型集合时，两者的损耗是在同一个数量级别上的。</p>
<p>​	以类型List<!-- raw HTML omitted -->为例， 索引器如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="na">[__DynamicallyInvokable]</span>
<span class="k">public</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
<span class="p">{</span>
<span class="na">    [TargetedPatchingOptOut(&#34;Performance critical to inline across NGen image boundaries&#34;), __DynamicallyInvokable]</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="m">_</span><span class="n">size</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ThrowHelper</span><span class="p">.</span><span class="n">ThrowArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="m">_</span><span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="p">}</span>
<span class="na">    [TargetedPatchingOptOut(&#34;Performance critical to inline across NGen image boundaries&#34;), __DynamicallyInvokable]</span>
    <span class="k">set</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="m">_</span><span class="n">size</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ThrowHelper</span><span class="p">.</span><span class="n">ThrowArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="m">_</span><span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="m">_</span><span class="n">version</span><span class="p">++;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>迭代器如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="na">[__DynamicallyInvokable]</span>
<span class="k">public</span> <span class="kt">bool</span> <span class="n">MoveNext</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="n">version</span> <span class="p">==</span> <span class="n">list</span><span class="p">.</span><span class="m">_</span><span class="n">version</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">index</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="m">_</span><span class="n">size</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">current</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="m">_</span><span class="n">items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">index</span><span class="p">++;</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">MoveNextRare</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="na">[__DynamicallyInvokable]</span>
<span class="k">public</span> <span class="n">T</span> <span class="n">Current</span>
<span class="p">{</span>
<span class="na">    [__DynamicallyInvokable, TargetedPatchingOptOut(&#34;Performance critical to inline this type of method across NGen image boundaries&#34;)]</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">current</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，List<!-- raw HTML omitted -->类内部维护着一个泛型数组:</p>
<p><code>private T[] _items;</code></p>
<p>无论是for循环还是foreach循环，内部都是对该数组的访问，而迭代器仅仅是多进行了一次版本检测。事实上，在循环内部，两者生成的IL代码也是差不多的，因为版本检测的缘故，foreach循环并不能代替for循环。</p>
<h3 id="建议19使用更有效的对象和集合初始化">建议19：使用更有效的对象和集合初始化</h3>
<p>依赖于属性和FCL提供的语法规则， 我们有了更加简洁有效的对象和初始化机制：对象和集合初始化设定项；</p>
<p>对象初始化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Mike&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">20</span><span class="p">};</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		对象初始化设定项支持在大括号中对自动实现的属性进行赋值。以往只能依靠构造方法传值进去，或者在对象构造完毕后对属性进行赋值。现在这些步骤简化了，初始化设定项实际上相当于编译器在对象生成后对属性进行了赋值。</p>
<p>集合初始化同样进行了简化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">personList</span><span class="p">=</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;rose&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">19</span><span class="p">},</span>
    <span class="n">person</span><span class="p">,</span>
    <span class="k">null</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>使用集合初始化设定项， 编译器就会在集合对象创建完毕后对集合调用Add方法；</p>
<p>上面这段代码演示了如何在初始化语句中创建一个新对象或者一个现有对象，以及一个null值；</p>
<p>不过，初始化设定项不仅仅是为了对象和集合初始化方便，为LINQ查询返回的集合中匿名类型的属性都是只读的，如果需要为匿名类型属性赋值，或者增加属性，只能通过初始化设定项来进行。初始化设定项还能为属性使用表达式。</p>
<p>下面的代码LINQ查询中创建了一个新的匿名类型，该类型含有属性Name和AgeScope，而AgeScope需要通过计算Person的Age属性得到；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice18</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">personList2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">19</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">45</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Jessica&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">20</span> <span class="p">},</span>
            <span class="p">};</span>

            <span class="kt">var</span> <span class="n">pTemp</span> <span class="p">=</span> <span class="k">from</span> <span class="n">p</span> <span class="k">in</span> <span class="n">personList2</span> <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">AgeScope</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">Age</span> <span class="p">&gt;</span> <span class="m">20</span> <span class="p">?</span> <span class="s">&#34;Old&#34;</span> <span class="p">:</span> <span class="s">&#34;Young&#34;</span> <span class="p">};</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">pTemp</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&#34;{0}:{1}&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">AgeScope</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="建议20使用泛型集合代替非泛型集合">建议20：使用泛型集合代替非泛型集合</h3>
<p>我们知道，要想让代码能够高效的运行，应该尽量避免装箱和拆箱，以及尽量少的转型，很遗憾，在微软提供给我们的第一代集合类型中没有做到这一点，下面我们看ArrayList这个类的使用情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">ArrayList</span> <span class="n">al</span><span class="p">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;bomir&#34;</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">al</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面这段代码充分演示了我们可以将程序写得多么糟糕。</p>
<p>首先，ArrayList的Add方法接受一个object参数，所以al.Add(1)首先会完成一次装箱；</p>
<p>其次，在foreach循环中，待遍历到它时，又将完成一次拆箱。</p>
<p>在这段代码中，整形和字符串作为<strong>值类型</strong>和<strong>引用类型</strong>，都会先被隐式地强制转型为object，然后在foreach循环中又被转型回来。同时，这段代码也是<strong>非类型安全</strong>的：我们然ArrayList同时存储了整型和字符串，但是缺少编译时的类型检查。虽然有时候需要有意这样去实现，但是更多的时候，应该尽量避免。缺少类型检查，在运行时会带来隐含的Bug。</p>
<p>集合类ArrayList如果进行如下所示的运算，就会抛出一个<code>System.IvalidCastException</code>  (指定的转换无效)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">ArrayList</span> <span class="n">al</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
<span class="n">al</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;bomir&#34;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">t</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">item</span> <span class="k">in</span> <span class="n">al</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">t</span> <span class="p">+=</span> <span class="n">item</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ArrayList同时还提供了一个带<code>ICollection</code>参数的构造方法，可以直接接收数组，如下所示：</p>
<p><code>var intArr = new int[] { 0, 1, 2, 3, 4 }; ArrayList a1 = new ArrayList(intArr);</code></p>
<p>该方法的内部实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="c1">// Summary:
</span><span class="c1">//     Initializes a new instance of the System.Collections.ArrayList class that contains
</span><span class="c1">//     elements copied from the specified collection and that has the same initial capacity
</span><span class="c1">//     as the number of elements copied.
</span><span class="c1">//
</span><span class="c1">// Parameters:
</span><span class="c1">//   c:
</span><span class="c1">//     The System.Collections.ICollection whose elements are copied to the new list.
</span><span class="c1">//
</span><span class="c1">// Exceptions:
</span><span class="c1">//   T:System.ArgumentNullException:
</span><span class="c1">//     c is null.
</span><span class="c1"></span><span class="k">public</span> <span class="n">ArrayList</span><span class="p">(</span><span class="n">ICollection</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
    	<span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">GetResourceString</span><span class="p">(</span><span class="s">&#34;ArgumentNull_Collection&#34;</span><span class="p">));</span>
    <span class="p">}</span>

	<span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="m">_</span><span class="n">items</span> <span class="p">=</span> <span class="n">emptyArray</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="m">_</span><span class="n">items</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
    <span class="n">AddRange</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该<code>AddRange</code>方法最终调用了<code>InsertRange</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="c1">// Summary:
</span><span class="c1">//     Inserts the elements of a collection into the System.Collections.ArrayList at
</span><span class="c1">//     the specified index.
</span><span class="c1">//
</span><span class="c1">// Parameters:
</span><span class="c1">//   index:
</span><span class="c1">//     The zero-based index at which the new elements should be inserted.
</span><span class="c1">//
</span><span class="c1">//   c:
</span><span class="c1">//     The System.Collections.ICollection whose elements should be inserted into the
</span><span class="c1">//     System.Collections.ArrayList. The collection itself cannot be null, but it can
</span><span class="c1">//     contain elements that are null.
</span><span class="c1">//
</span><span class="c1">// Exceptions:
</span><span class="c1">//   T:System.ArgumentNullException:
</span><span class="c1">//     c is null.
</span><span class="c1">//
</span><span class="c1">//   T:System.ArgumentOutOfRangeException:
</span><span class="c1">//     index is less than zero. -or- index is greater than System.Collections.ArrayList.Count.
</span><span class="c1">//
</span><span class="c1">//   T:System.NotSupportedException:
</span><span class="c1">//     The System.Collections.ArrayList is read-only. -or- The System.Collections.ArrayList
</span><span class="c1">//     has a fixed size.
</span><span class="c1"></span><span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">InsertRange</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">ICollection</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">GetResourceString</span><span class="p">(</span><span class="s">&#34;ArgumentNull_Collection&#34;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">||</span> <span class="n">index</span> <span class="p">&gt;</span> <span class="m">_</span><span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">&#34;index&#34;</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">GetResourceString</span><span class="p">(</span><span class="s">&#34;ArgumentOutOfRange_Index&#34;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">EnsureCapacity</span><span class="p">(</span><span class="m">_</span><span class="n">size</span> <span class="p">+</span> <span class="n">count</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">_</span><span class="n">size</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="m">_</span><span class="n">items</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="m">_</span><span class="n">items</span><span class="p">,</span> <span class="n">index</span> <span class="p">+</span> <span class="n">count</span><span class="p">,</span> <span class="m">_</span><span class="n">size</span> <span class="p">-</span> <span class="n">index</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">object</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
        <span class="n">c</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">array</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="m">_</span><span class="n">items</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
        <span class="m">_</span><span class="n">size</span> <span class="p">+=</span> <span class="n">count</span><span class="p">;</span>
        <span class="m">_</span><span class="n">version</span><span class="p">++;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		概括来讲，如果对大型集合进行循环访问、转型或装箱和拆箱操作，使用ArrayList这样的传统集合对效率影响会非常大。鉴于此，微软提供了对泛型的支持。泛型使用一对&lt;&gt;括号将实际类型括起来，然后编译器和运行时会完成剩余的工作。微软也不建议大家使用ArrayList这样的类型了，转而建议使用它们的泛型实现，如List<!-- raw HTML omitted -->。</p>
<p>​		注意，非泛型集合在<code>System.Collections</code>命名空间下，对应的泛型集合则在<code>System.Collections.Generic</code>命名空间下。</p>
<p>​		最后作者以ArrayList和List<!-- raw HTML omitted -->为例， 测试10000000次， 比较非泛型集合和泛型集合在运行中的效率：</p>
<blockquote>
<p>输出为：</p>
<p>开始测试ArrayList:</p>
<p>耗时：2375</p>
<p>垃圾回收次数：26</p>
<p>开始测试List<!-- raw HTML omitted -->:</p>
<p>耗时：220</p>
<p>垃圾回收次数：5</p>
</blockquote>
<p>可见这种情形， 使用泛型集合效率是比较占优的；</p>
<h3 id="建议21选择正确的集合">建议21：选择正确的集合</h3>
<p>要选择正确的集合， 首先得回顾一下数据结构的知识，所谓数据结构，是指相互之间存在一种或多种特定关系的数据元素的集合。</p>
<p><strong>集合的分类</strong>参考如下图：</p>
<p><img src="https://bomir.top/pics/CSharpAdvice/collection_classify.png" alt=""></p>
<p>由于非泛型集合存在效率低以及非类型安全的特点， 因此我们聚焦在泛型集合上面；</p>
<p>如果集合的数目固定并且不涉及转型，使用数组的效率高，否则使用List<!-- raw HTML omitted -->;</p>
<p>线性表是线性结构，也是顺序存储结构。顺序存储需要开辟一个定长的空间，读写速度快，缺点不可扩充容量(如果要扩充需要开辟一个新的足够大的空间把原来的数据重写进去)，链式存储无需担心容量问题，读写速度相对慢些，由于要存储下一个数据的地址所以需要的存储空间比顺序存储大。</p>
<p>如果元素个数已知，且插入删除较少的可以使用顺序结构，而对于频繁有插入删除操作，元素个数未知的，最好使用链式结构，编程时可结合要处理的数据的特点设计数据结构的。</p>
<p>例如队列Queue<!-- raw HTML omitted -->遵循的是先进先出模式，它在集合末尾添加元素，在集合的起始位置删除元素。根据队列的特点，可以用它来处理并发命令等场景：先让所有的客户端的命令入队，然后，由专门的工作线程来执行命令。在分布式中的消息队列就是一个典型的队列应用实例；</p>
<p>栈Stack<!-- raw HTML omitted -->遵循的是后进先出的模式，它在集合末尾添加集合，同时也在末尾删除元素；</p>
<p>字典Dictionary&lt;Tkey, TValue&gt;存储的是键值对，值在基于键的散列码的基础上进行存储。字典类对象由包含集合元素的存储桶组成，每一个存储桶与基于该元素的键的哈希值关联。如果需要根据键进行值的查找，使用Dictionary&lt;TKey,TValue&gt;将会是搜索和检索更快捷。</p>
<p>双向链表LinkedList<!-- raw HTML omitted -->是一个类型为LinkedListNode的元素对象的集合。当我们觉得在集合中插入和删除数据很慢时，可以考虑使用链表。如果使用LinkedList<!-- raw HTML omitted -->，我们会发现此类型并没有其他集合普遍具有的Add方法，取而代之的是AddAfter、AddBefore、AddFirst、AddLast等方法。双向链表的每个节点都向前指向Previous节点，向后指向Next节点。</p>
<p>还有几个类型：SortedList<!-- raw HTML omitted -->、SortedDictionary&lt;TKye,TValue&gt;、SortedSet<!-- raw HTML omitted -->，它们所对应的类分别是：List<!-- raw HTML omitted -->、Dictionary&lt;TKye,TValue&gt;、HashSet<!-- raw HTML omitted -->， 作用是将原来无序排列变为有序排列。</p>
<p>在命名空间System.Collections.Concurrent下，还涉及几个多线程集合类：ConcurrentBag<!-- raw HTML omitted -->、ConcurrentDictionary<!-- raw HTML omitted -->、ConcurrentQueue<!-- raw HTML omitted -->、ConcurrentStack<!-- raw HTML omitted -->，分别对应List<!-- raw HTML omitted -->、Dictionary&lt;TKye,TValue&gt;、Queue<!-- raw HTML omitted -->、Stack<!-- raw HTML omitted -->。在实际工作中，应该根据需要选择合适的集合类。</p>
<h3 id="建议22确保集合的线程安全">建议22：确保集合的线程安全</h3>
<p>集合的线程安全是指多个线程在集合上添加或删除元素时，线程键必须保证同步；</p>
<p>下面代码模拟了一个线程在迭代过程中，另一个线程对元素进行了删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">19</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">45</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Jessica&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">20</span> <span class="p">},</span>
        <span class="p">};</span>

        <span class="k">static</span> <span class="n">AutoResetEvent</span> <span class="n">autoSet</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Thread</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="c1">// 确保等待t2开始之后才运行下面的代码
</span><span class="c1"></span>                <span class="n">autoSet</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>

                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;t1:&#34;</span> <span class="p">+</span> <span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

            <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="c1">// 确保等待t2开始之后才运行下面的代码
</span><span class="c1"></span>                <span class="n">autoSet</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>

                <span class="c1">// 沉睡1s是为了确保删除操作在t1的迭代过程中
</span><span class="c1"></span>                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
                <span class="n">list</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>以上代码运行过程会抛出InvalidOperationException：“集合已修改，可能无法执行枚举。”</p>
<p>早在泛型集合出现之前，非泛型集合一般提供一个SyncRoot属性，要保证非泛型集合的线程安全，可以通过锁定该属性来实现。如果上面的集合用ArrayList代替，保证其线程安全则应该在迭代和删除的时候都加上lock，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">ArrayList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">19</span> <span class="p">},</span>
        <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">45</span> <span class="p">},</span>
        <span class="k">new</span> <span class="n">Person</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Jessica&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">20</span> <span class="p">},</span>
    <span class="p">};</span>
    <span class="k">static</span> <span class="n">AutoResetEvent</span> <span class="n">autoSet</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

    <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">// 确保等待t2开始之后才运行下面的代码
</span><span class="c1"></span>            <span class="n">autoSet</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>

            <span class="k">lock</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">SyncRoot</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">Person</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;t1:&#34;</span> <span class="p">+</span> <span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
           
        <span class="p">});</span>
        <span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

        <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">// 通知t1可以开始执行代码
</span><span class="c1"></span>            <span class="n">autoSet</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>

            <span class="c1">// 沉睡1s是为了确保删除操作在t1的迭代过程中
</span><span class="c1"></span>            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">SyncRoot</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">list</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;删除成功&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以上的代码不会抛出异常，因为锁定通过互斥的机制保证了同一时刻只能有一个线程操作集合元素。我们进而发现泛型集合没有这样的属性，必须要自己创建一个锁定对象来完成同步任务。可以new一个静态对象来进行锁定，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">static</span> <span class="kt">object</span> <span class="n">syncObj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>

<span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
     <span class="n">Thread</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
     <span class="p">{</span>
         <span class="c1">// 确保等待t2开始之后才运行下面的代码
</span><span class="c1"></span>         <span class="n">autoSet</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>

         <span class="k">lock</span> <span class="p">(</span><span class="n">syncObj</span><span class="p">)</span>
          <span class="p">{</span>
             <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;t1:&#34;</span> <span class="p">+</span> <span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
                 <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="p">});</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

    <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
     <span class="p">{</span>
         <span class="c1">// 通知t1可以开始执行代码
</span><span class="c1"></span>         <span class="n">autoSet</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>

         <span class="c1">// 沉睡1s是为了确保删除操作在t1的迭代过程中
</span><span class="c1"></span>         <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
         <span class="k">lock</span> <span class="p">(</span><span class="n">syncObj</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">list</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
             <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;删除成功&#34;</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">});</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="建议23避免将list作为自定义集合类的基类">建议23：避免将List作为自定义集合类的基类</h3>
<p>​	如果要实现一个自定义的集合类，不应该以一个FCL集合类为基类，反而应该扩展相应的泛型接口；FCL集合类应该以组合的形式包含至自定义的集合类，需要扩展的泛型接口通常是IEnumerable<!-- raw HTML omitted -->和ICollection<!-- raw HTML omitted -->（或ICollection<!-- raw HTML omitted -->的子接口，如IList<!-- raw HTML omitted -->），前者规范了集合类的迭代功能，后者规范了一个集合通常会有的操作。</p>
<p>一般的情况下，下面实现的集合类都能完成默认的需求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c#" data-lang="c#"><span class="k">class</span> <span class="nc">Employees1</span> <span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">Employees2</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;,</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>不过，List<!-- raw HTML omitted -->基本上没有提供可供子类使用的protected成员（从object中继承的Finalize和MemberwiseClone方法除外），所以继承List<!-- raw HTML omitted -->不会带来任何继承上的优势，反而丧失了面向接口编程的灵活性，稍加不注意，隐藏的bug便会接踵而至了；</p>
<p>以Employees1为例，如果要在Add方法中加入某些需求方面的变化，比如，为名字添加一个后缀“Changed!&quot;，但是客户端的开发人员也许已经习惯了面向接口编程的方式，它在为集合添加一个元素是使用了如下的语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">namespace</span> <span class="nn">Advice23</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Employee</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Employees1</span> <span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">new</span> <span class="k">void</span> <span class="n">Add</span><span class="p">(</span><span class="n">Employee</span> <span class="n">item</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">item</span><span class="p">.</span><span class="n">Name</span> <span class="p">+=</span> <span class="s">&#34; Changed&#34;</span><span class="p">;</span>
            <span class="k">base</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Employees1</span> <span class="n">employees1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Employees1</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="n">Employee</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Mike&#34;</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Employee</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span> <span class="p">},</span>
            <span class="p">};</span>

            <span class="n">IList</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span> <span class="n">employees</span> <span class="p">=</span> <span class="n">employees1</span><span class="p">;</span>
            <span class="n">employees</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Employee</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span> <span class="p">});</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">employees1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>于是， 代码的实际输出会偏离集合类的设计者的设想；输出如下：</p>
<p><img src="E:%5COneDriveDisk%5COneDrive%5Cmds%5C%E6%94%B9%E5%96%84C#%E4%BB%A3%E7%A0%81%E7%9A%84157%E4%B8%AA%E5%BB%BA%E8%AE%AE%5Cassets%5C1638670294591.png" alt="1638670294591"></p>
<p>如果要修正这类行为，应该采用Employee2的方式:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">class</span> <span class="nc">Employees2</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;,</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span> <span class="n">items</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">Add</span><span class="p">(</span><span class="n">Employee</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">item</span><span class="p">.</span><span class="n">Name</span> <span class="p">+=</span> <span class="s">&#34; Changed!&#34;</span><span class="p">;</span>
        <span class="n">items</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsReadOnly</span> <span class="p">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Contains</span><span class="p">(</span><span class="n">Employee</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">CopyTo</span><span class="p">(</span><span class="n">Employee</span><span class="p">[]</span> <span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arrayIndex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Remove</span><span class="p">(</span><span class="n">Employee</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出的结果为：<img src="E:%5COneDriveDisk%5COneDrive%5Cmds%5C%E6%94%B9%E5%96%84C#%E4%BB%A3%E7%A0%81%E7%9A%84157%E4%B8%AA%E5%BB%BA%E8%AE%AE%5Cassets%5C1638671404343.png" alt="1638671404343"></p>
<h3 id="建议24迭代器应该是只读的">建议24：迭代器应该是只读的</h3>
<p>如果留心观察就会注意到，FCL(Framework class library)中的迭代器只有GetEnumerator方法，没有SetEnumerator方法，所有的集合类也没有一个可以写的迭代器属性。原因有二：</p>
<ul>
<li>这违背了设计模式的开闭原则；被设置到集合中的迭代器可能会直接导致集合的行为发生异常或变动；一旦确实需要新的迭代要求，完全可以创建一个新的迭代器来满足需求，而不是为集合设置该迭代器，因为这样做会直接导致使用该集合对象的其他迭代场景发生不可知的行为；</li>
<li>我们有了LINQ，使用LINQ现在不用创建任何新的类型就能满足任何的迭代需求；</li>
</ul>
<p>如果迭代器可写，危害的demo如下：</p>
<p>假设存在一个公共的集合对象，有两个业务类需要对这个集合进行操作：</p>
<p>业务类A只负责将元素迭代显示到UI上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">private</span> <span class="n">IMyEnumerable</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyList</span><span class="p">();</span>
<span class="k">private</span> <span class="n">IMyEnumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
<span class="k">while</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>业务类B出于自己的某种需求，要实现一个新的针对集合对象的迭代器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">private</span> <span class="n">MyEnumerator2</span> <span class="n">enumerator2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyEnumerator2</span><span class="p">(</span><span class="n">list</span> <span class="k">as</span> <span class="n">MyList</span><span class="p">);</span>
<span class="p">(</span><span class="n">list</span> <span class="k">as</span> <span class="n">MyList</span><span class="p">).</span><span class="n">SetEnumerator</span><span class="p">(</span><span class="n">enumerator2</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="n">enumerator2</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">current</span> <span class="p">=</span> <span class="n">enumerator2</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​	现在再回到业务A类上执行一次迭代，结果将会是B所设置的迭代器输出。这相当于B在没有通知A的情况下产生了干扰，这是应该避免的；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="p">(</span><span class="n">list</span> <span class="k">as</span> <span class="n">MyList</span><span class="p">).</span><span class="n">SetEnumerator</span><span class="p">(</span><span class="n">enumerator2</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>事实上，上面的代码即使没有下面这行代码也会运行得很好；</p>
<p>所以，不要为迭代器设置可写属性；</p>
<h3 id="建议25谨慎集合属性的可写操作">建议25：谨慎集合属性的可写操作</h3>
<p>​	如果类型的属性中有集合属性，那么应该保证属性对象是由类型本身产生的。如果将属性设置为可写，则会增加抛出异常的几率；一般情况下，如果集合属性没有值，则它返回的Count等于0，而不是集合属性的值为null。下面的代码将产生一个<code>NullReferenceException</code>异常:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">namespace</span> <span class="nn">Advice25</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">studentList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Student</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;mike&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">11</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Student</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">21</span> <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">StudentTeamA</span> <span class="n">teamA</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StudentTeamA</span><span class="p">();</span>

            <span class="n">Thread</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">teamA</span><span class="p">.</span><span class="n">Students</span> <span class="p">=</span> <span class="n">studentList</span><span class="p">;</span>
                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">3000</span><span class="p">);</span>

                <span class="c1">// 模拟对集合属性进行一些运算
</span><span class="c1"></span>                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">studentList</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

            <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="c1">// 模拟在别的地方对list而不是属性本身赋值为null
</span><span class="c1"></span>                <span class="n">studentList</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">});</span>

            <span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Student</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">StudentTeamA</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">Students</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面代码的问题是：线程t1模拟将对类型StudentTeamA的Students属性进行赋值，它是一个可读/可写的属性。由于集合属性是一个引用类型，而当前针对该属性对象的引用却又两个，即集合本身和调用者的类型变量studentList，线程t2也许是另一个程序员写的，但他看到的只有studentList，结果，针对studentList的修改hi直接影响到另一个工作线程的对象。在例子中，我们将studentList赋值为null，模拟在StudentTeamA（或者说工作线程t1）不知情的情况下使得集合属性变为null。接着，线程t1模拟针对Students属性进行若干操作，导致抛出异常。</p>
<p>下面的StudentTeamA版本是一个改进过的版本。首先，将类型的集合属性设置为只读；其次，集合对象由类型自身创建，这保证了集合属性永远只有一个引用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">namespace</span> <span class="nn">Advice25</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">studentList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Student</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;mike&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">11</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Student</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">21</span> <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">StudentTeamA</span> <span class="n">teamA</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StudentTeamA</span><span class="p">();</span>
            <span class="n">teamA</span><span class="p">.</span><span class="n">Students</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Student</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">22</span> <span class="p">});</span>
            <span class="n">teamA</span><span class="p">.</span><span class="n">Students</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="n">studentList</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">teamA</span><span class="p">.</span><span class="n">Students</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>

            <span class="c1">// 也可以像下面一样实现
</span><span class="c1"></span>            <span class="n">StudentTeamA</span> <span class="n">teamA1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StudentTeamA</span><span class="p">(</span><span class="n">studentList</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">teamA1</span><span class="p">.</span><span class="n">Students</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Student</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">StudentTeamA</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">Students</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">StudentTeamA</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Students</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">StudentTeamA</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span> <span class="n">studentList</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Students</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="n">studentList</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在改进版本的StudentTeamA中尝试对属性Students进行赋值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"> <span class="n">teamA</span><span class="p">.</span><span class="n">Students</span> <span class="p">=</span> <span class="n">listStudent</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这将会导致编译通不过;</p>
<h3 id="建议26使用匿名类型存储linq查询结果">建议26：使用匿名类型存储LINQ查询结果</h3>
<p>从.NET3.0开始，C#开始支持一个新特性：匿名类型。匿名类型有var、赋值运算符和一个非空初始值（或以new开头的初始化项）组成。匿名类型有如下基本特性：</p>
<ul>
<li>即支持简单类型也支持复杂类型。简单类型必须是一个非空初始值，复杂类型则是一个以new开头的初始化项。</li>
<li>匿名类型的属性是只读的，没有属性设置器，它一旦被初始化就不可更改。</li>
<li>如果两个匿名类型的属性值相同，那么就认为这两个匿名类型相等。</li>
<li>匿名类型可以在循环中用作初始化器。</li>
<li>匿名类型支持智能感知。</li>
<li>匿名类型可以拥有方法。</li>
</ul>
<p>在类型仅仅被当前的代码使用，或者被用于存储某种查询结果的场景中，匿名类型的用途会很大。匿名类型是保存LINQ查询结果的最佳搭档；</p>
<p>如下场景：</p>
<p>将Person或Person相关类（如Company）从数据库中取出来，我们需要将Person中的属性Name和根据CompanyID对应起来的Company的属性Name联系起来，形成一个新的类型。这个新的类型也许用于某个UI控件的绑定源，也许用于某个特殊算法的输入。总之，数据库中的格式一旦设计完毕并投入使用，很少会有变动，但是需求却千变万化，实际需求需要创建很多这样的临时类型。如果这临时类型全部使用普通的自定义类型，代码将会膨胀起来变得难以维护。这个时候，匿名类型就派上用场了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice26</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//为了演示需要companyList并不从数据库读取，而是直接赋值
</span><span class="c1"></span>            <span class="n">List</span><span class="p">&lt;</span><span class="n">Company</span><span class="p">&gt;</span> <span class="n">companyList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Company</span><span class="p">&gt;()</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="n">Company</span><span class="p">(){</span> <span class="n">ComanyID</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Microsoft&#34;</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Company</span><span class="p">(){</span> <span class="n">ComanyID</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Google&#34;</span> <span class="p">}</span>
            <span class="p">};</span>
            <span class="c1">//为了演示需要personList并不从数据库读取，而是直接赋值
</span><span class="c1"></span>            <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">personList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Mike&#34;</span><span class="p">,</span> <span class="n">CompanyID</span> <span class="p">=</span> <span class="m">1</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">CompanyID</span> <span class="p">=</span> <span class="m">0</span> <span class="p">},</span>
                <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">CompanyID</span> <span class="p">=</span> <span class="m">1</span> <span class="p">}</span>
            <span class="p">};</span>

            <span class="kt">var</span> <span class="n">personWithCompanyList</span> <span class="p">=</span> <span class="k">from</span> <span class="n">person</span> <span class="k">in</span> <span class="n">personList</span>
                                        <span class="k">join</span> <span class="n">company</span> <span class="k">in</span> <span class="n">companyList</span> <span class="k">on</span> <span class="n">person</span><span class="p">.</span><span class="n">CompanyID</span> <span class="k">equals</span> <span class="n">company</span><span class="p">.</span><span class="n">ComanyID</span>
                                        <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">PersonName</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">CompanyName</span> <span class="p">=</span> <span class="n">company</span><span class="p">.</span><span class="n">Name</span> <span class="p">};</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">personWithCompanyList</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&#34;{0}\t:{1}&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">PersonName</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">CompanyName</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">CompanyID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Company</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ComanyID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="E:%5COneDriveDisk%5COneDrive%5Cmds%5C%E6%94%B9%E5%96%84C#%E4%BB%A3%E7%A0%81%E7%9A%84157%E4%B8%AA%E5%BB%BA%E8%AE%AE%5Cassets%5C1638677129624.png" alt="1638677129624"></p>
<p>我们用ildasm查看IL的代码，可以看见匿名类型在IL中会生成 一个类， 也称之为投影；</p>
<p><img src="E:%5COneDriveDisk%5COneDrive%5Cmds%5C%E6%94%B9%E5%96%84C#%E4%BB%A3%E7%A0%81%E7%9A%84157%E4%B8%AA%E5%BB%BA%E8%AE%AE%5Cassets%5C1638677474838.png" alt="1638677474838"></p>
<p>非匿名类型包括的Equals、GetHashcode、ToString等方法匿名类型都有。并且编译器为我们重载了ToString方法，它返回的是类型的属性即对应的值。</p>
<h3 id="建议27在查询中使用lambda表达式">建议27：在查询中使用Lambda表达式</h3>
<p>LINQ实际上是基于扩展方法和lambda表达式的，任何LINQ的查询都能通过扩展方法的方式来代替：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="kt">var</span> <span class="n">personWithCompanyList</span> <span class="p">=</span> <span class="k">from</span> <span class="n">person</span> <span class="k">in</span> <span class="n">personList</span>
                                        <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">PersonName</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">CompanyName</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="n">CompanyID</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="s">&#34;Micro&#34;</span> <span class="p">:</span> <span class="s">&#34;Sun&#34;</span> <span class="p">};</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">person</span> <span class="k">in</span> <span class="n">personWithCompanyList</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">person</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
            <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其等价于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">personList</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span> <span class="n">person</span><span class="p">=&gt;</span><span class="k">new</span> <span class="p">{</span> <span class="n">PersonName</span><span class="p">=</span><span class="n">person</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="n">CompanyName</span><span class="p">=</span><span class="n">person</span><span class="p">.</span><span class="n">CompanyID</span><span class="p">==</span><span class="m">0</span><span class="p">?</span><span class="s">&#34;Micro&#34;</span><span class="p">:</span><span class="s">&#34;Sun&#34;</span><span class="p">}))</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		针对LINQ设计的扩展方法大多应用了泛型委托。System命名空间定义了泛型委托Action， Func和Predicate。Action用于执行一个动作，所以它没有返回值；Func用于执行一个操作并返回一个值；Predicate用于定义一组条件并判读参数是否符合条件。</p>
<p>Select扩展方法接受的就是一个Func委托，而Lambda表达式就是一个简洁的委托，运算符“=&gt;”左边代表的是方法的参数，右边的是方法体。我们通过直接调用扩展方法来使用Lambda表达式，这样即完成了功能，也减少了一行代码。在实际工作中，应该灵活运用这种方式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"> <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">personWithCompanyList</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">CompanyName</span> <span class="p">==</span> <span class="s">&#34;Sun&#34;</span><span class="p">))</span>
 <span class="p">{</span>
 	<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">PersonName</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用<code>OrderByDescending</code>扩展方法， 针对PersonName进行排序:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c#" data-lang="c#"><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">personList</span><span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="n">person</span> <span class="p">=&gt;</span> <span class="n">person</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="建议28理解延迟求值和主动求值之间的区别">建议28：理解延迟求值和主动求值之间的区别</h3>
<p>要理解延迟求值(lazy evaluation)和主动求值(eager evaluation)，先看个demo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice28</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span> <span class="p">};</span>
            <span class="kt">var</span> <span class="n">temp1</span> <span class="p">=</span> <span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">where</span> <span class="n">c</span> <span class="p">&gt;</span> <span class="m">5</span> <span class="k">select</span> <span class="n">c</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">temp2</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">where</span> <span class="n">c</span> <span class="p">&gt;</span> <span class="m">5</span> <span class="k">select</span> <span class="n">c</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>

            <span class="n">list</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">11</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;temp1: &#34;</span><span class="p">);</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">temp1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span> <span class="p">+</span> <span class="s">&#34; &#34;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;temp2: &#34;</span><span class="p">);</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">temp2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">+</span> <span class="s">&#34; &#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​		在延迟求值的情况下， 只是定义了一个查询，而不会立刻执行；对查询的访问每次都会遍历原集合，如这个例子中的<code>temp1</code>的迭代，在迭代前我们修改了list[0]的值，可见，修改直接影响了迭代的输出。对查询结果调用<code>ToList</code>、<code>ToArray</code>等方法，将会使其立即执行，由于对list[0]的修改是在<code>temp2</code>查询之后进行的，所以针对list[0]的修改不会影响到<code>temp2</code>的结果；</p>
<p>​		在使用<code>LINQ to SQL</code>时候，延迟求值能带来显著的性能提升。例如，如果定义了两个查询，而且采用了延迟求值，CLR会合并两次查询并生成一个最终的查询；</p>
<p>​		事实上，应该仔细体会<code>延迟求值</code>和<code>主动求值</code>的差别，去体会在具体应用中带来的输出结果；不然我们可能会遭遇到意想不到的bug;</p>
<h3 id="建议29区别linq查询中的ienumerable和iqueryable">建议29：区别LINQ查询中的IEnumerable和IQueryable</h3>
<p>​	查询一共提供了两类i扩展方法，在<code>System.Linq</code>的命名空间下，有两个静态类：<strong>Enumerable类</strong>，它针对继承了IEnumerable<!-- raw HTML omitted -->接口的集合进行扩展；<strong>Queryable类</strong>，它针对继承了IQueryable<!-- raw HTML omitted -->接口的集合类进行扩扎。接口IQueryable<!-- raw HTML omitted -->也是继承了IEnumerable<!-- raw HTML omitted -->接口的，所以，致使两个接口的方法在很大程度上时一致的。</p>
<p>​		LINQ查询从功能上来讲实际上可分为3类：</p>
<ul>
<li>LINQ to OBJECTS</li>
<li>LINQ to SQL</li>
<li>LINQ to XML</li>
</ul>
<p>​	设计两套接口的目的在于区分LINQ to OBJECTS，LINQ  TO SQL , 两者对于查询的结果在内部使用的是完全不同的机制。</p>
<p>​	针对LINQ to OBJECTS时，使用Enumerable中的扩展方法对本地集合进行排序和查询等操作，查询参数接受的是Func&lt;&gt;。Func&lt;&gt;叫做<strong>谓语表达式</strong>，相当于一个委托。针对LINQ to SQL时，则使用Queryable中的扩展方法，它接受的是Expression&lt;&gt;。Expression&lt;&gt;用于包装Func&lt;&gt;。LINQ to SQL最终会将表达式树转换成相应的SQL语句，然后在数据库中执行。</p>
<p>​	简单的说：本地数据源用IEnumerable<!-- raw HTML omitted -->，远程数据源用IQueryable<!-- raw HTML omitted -->。</p>
<p>​	在使用IEnumerable<!-- raw HTML omitted -->和IQueryable<!-- raw HTML omitted -->的时候还需要注意，IEnumerable<!-- raw HTML omitted -->查询的逻辑可言直接用我们自定义的方法，而IQueryable<!-- raw HTML omitted -->则不能使用自定义的方法，它必须先生成表达式树，查询由LINQ to SQL引擎处理。在使用IQueryable<!-- raw HTML omitted -->查询的时候，若果使用自定义方法，则会抛出异常。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">DataContext</span> <span class="n">ctx</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DataContext</span><span class="p">(</span><span class="s">&#34;server=192.168.0.102;database=Temp;uid=sa;pwd=sa123&#34;</span><span class="p">);</span>
            <span class="n">Table</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">persons</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">GetTable</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;();</span>
            <span class="kt">var</span> <span class="n">temp1</span> <span class="p">=</span> <span class="k">from</span> <span class="n">p</span> <span class="k">in</span> <span class="n">persons</span> <span class="k">where</span> <span class="n">OlderThan20</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Age</span><span class="p">)</span> <span class="k">select</span> <span class="n">p</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">temp1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&#34;Name:{0}\tAge:{1}&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Age</span><span class="p">));</span>
            <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这将会抛出异常<code>NotSupportedException</code>：方法“<code>Boolean OlderThan20(Int32)</code>”不支持转换为SQL。</p>
<p>但是，如果我们将查询转换成一个IEnumerable<!-- raw HTML omitted -->查询，这种模式是支持的：</p>
<h3 id="建议30使用linq取代集合中的比较器和迭代器">建议30：使用LINQ取代集合中的比较器和迭代器</h3>
<p>LINQ提供了类似SQL语句的语法来实现遍历，筛选与投影集合的功能；</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">List</span><span class="p">&lt;</span><span class="n">Salary</span><span class="p">&gt;</span> <span class="n">companySalary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Salary</span><span class="p">&gt;()</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="n">Salary</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Mike&#34;</span><span class="p">,</span> <span class="n">BaseSalary</span> <span class="p">=</span> <span class="m">3000</span><span class="p">,</span> <span class="n">Bonus</span> <span class="p">=</span> <span class="m">1000</span> <span class="p">},</span>
    <span class="k">new</span> <span class="n">Salary</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Rose&#34;</span><span class="p">,</span> <span class="n">BaseSalary</span> <span class="p">=</span> <span class="m">2000</span><span class="p">,</span> <span class="n">Bonus</span> <span class="p">=</span> <span class="m">4000</span> <span class="p">},</span>
    <span class="k">new</span> <span class="n">Salary</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Jeffry&#34;</span><span class="p">,</span> <span class="n">BaseSalary</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span> <span class="n">Bonus</span> <span class="p">=</span> <span class="m">6000</span> <span class="p">},</span>
    <span class="k">new</span> <span class="n">Salary</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Steve&#34;</span><span class="p">,</span> <span class="n">BaseSalary</span> <span class="p">=</span> <span class="m">4000</span><span class="p">,</span> <span class="n">Bonus</span> <span class="p">=</span> <span class="m">3000</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">var</span> <span class="n">orderByBaseSalary</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">companySalary</span> <span class="k">orderby</span> <span class="n">s</span><span class="p">.</span><span class="n">BaseSalary</span> <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">orderByBonus</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">companySalary</span> <span class="k">orderby</span> <span class="n">s</span><span class="p">.</span><span class="n">Bonus</span> <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>​	foreach实际隐含调用的是集合对象orderByBaseSalary和orderByBouns的迭代器。以往，如果我们要绕开集合的Sort方法对集合按照一定的顺序进行迭代，则需要让类型继承IEnumerable接口（泛型集合是IEnumerable<!-- raw HTML omitted -->接口），实现一个或多个迭代器。现在从LINQ查询生成匿名类来看，相当于可以无限为集合增加迭代需求。</p>
<p>​	我们可以利用LINQ的强大功能来简化我们的代码，但是LINQ功能的实现本身就是借助FCL泛型集合的比较器、迭代器、索引器的。LINQ相当于封装了这些功能，让我们使用起来更加方便。在命名空间System.Linq下存在很多静态类，这些静态类存在的意义就是为FCL的泛型集合提供扩展方法。</p>
<p>​	这条语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="kt">var</span> <span class="n">orderByBaseSalary</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">companySalary</span> <span class="k">orderby</span> <span class="n">s</span><span class="p">.</span><span class="n">BaseSalary</span> <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>orderby实际上是调用了System.Linq.Enumerable类型的OrderBy方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">public</span> <span class="k">static</span> <span class="n">IOrderedEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;</span> <span class="n">OrderBy</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="n">keySelector</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//省略
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​	这是一个扩展方法，它为继承了IEnumerable<!-- raw HTML omitted -->接口的集合类型提供排序的功能。</p>
<p>​	作者老师在这条建议中强烈推荐我们利用LINQ所带来的的便捷性，但是我们仍需掌握比较器、迭代器、索引器的原理，以便更好的理解LINQ的思想，写出更高质量的代码；</p>
<h3 id="建议31在linq查询中避免不必要的迭代">建议31：在LINQ查询中避免不必要的迭代</h3>
<p>​	无论是SQL查询还是LINQ查询，搜索到结果立刻返回总比搜索完所有的结果再将结果返回的效率要更高；现在来创建一个自定义的集合类型来说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Advice31</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MyList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyList</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">temp</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">where</span> <span class="n">c</span><span class="p">.</span><span class="n">Age</span> <span class="p">==</span> <span class="m">20</span> <span class="k">select</span> <span class="n">c</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
            <span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">temp2</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">where</span> <span class="n">c</span><span class="p">.</span><span class="n">Age</span> <span class="p">&gt;=</span> <span class="m">20</span> <span class="k">select</span> <span class="n">c</span><span class="p">).</span><span class="n">First</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
            <span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">MyList</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">IteratedNum</span><span class="p">++;</span>

                <span class="k">yield</span> <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">GetEnumerator</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;aehyok&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">23</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;kris&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">20</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;leo&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">25</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;niki&#34;</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="m">21</span> <span class="p">},</span>
        <span class="p">};</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">IteratedNum</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">Person</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">i</span><span class="p">]</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>

            <span class="k">set</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>​	通过结果发现，第二种的性能明显要比第一种的性能要好很多；第一种查询用了4次，而第二种仅有1次；</p>
<p>​	与First方法类似的还有Take方法，Take方法接收一个整型参数，然后为我们返回该参数指定的元素个数。与First一样，它满足条件以后，会从当前的迭代过程直接返回，而不是等到整个迭代过程完毕再返回。如果一个集合包含了很多的元素，那么这种查询会为我们带来可观的时间效率。</p>
<p>​	再来看下面的例子，虽然LINQ查询的最后结果都是返回包含了两个元素&quot;Niki&quot;对象，但是实际上，使用Take方法仅仅为我们迭代了2次，而使用where查询方式带来的确实整个集合的迭代，首先修改一下集合类中的元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span><span class="p">=</span><span class="s">&#34;Niki&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">25</span><span class="p">},</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span><span class="p">=</span><span class="s">&#34;Niki&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">30</span><span class="p">},</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span><span class="p">=</span><span class="s">&#34;Kris&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">20</span><span class="p">},</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span><span class="p">=</span><span class="s">&#34;Leo&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">25</span><span class="p">},</span>
    <span class="k">new</span> <span class="n">Person</span><span class="p">(){</span> <span class="n">Name</span><span class="p">=</span><span class="s">&#34;aehyok&#34;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">30</span><span class="p">}</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>调用</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C#" data-lang="C#"><span class="kt">var</span> <span class="n">temp</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">select</span> <span class="n">c</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">2</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">temp2</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">list</span> <span class="k">where</span> <span class="n">c</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">&#34;Niki&#34;</span> <span class="k">select</span> <span class="n">c</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">IteratedNum</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>

<span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>在实际的代码中，应充分的应用First和Take等方法，这样才能为我们的应用带来高效性，而不会让时间耗费在一些无效的迭代中；</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">bomir</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2019-11-20
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bomir.top/tags/csharp/">CSharp</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/goodbye_to_diego/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">See You Diego</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/csharp-others-talk/">
            <span class="next-text nav-default">C#杂项聊一聊</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Shaper-fox/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:jinchunw@385@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Bicomir" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bomir.top/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>
  <span class="copyright-year">
    &copy;
    
      2017 -
    2021
    <span class="heart">
      
      <i class="iconfont">        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        bomir
        
      </span>
	  <span class="division">|</span>
	  <span class="author">
			<a href="http://beian.miit.gov.cn/">粤ICP备2021140392号-1</a>
	  </span></span>
  
  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
